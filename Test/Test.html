<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game</title>
    <style>
        /* Animations */
        @keyframes lose {
            33% {
                transform: translateX(-5%);
            }
            66% {
                transform: translateX(5%);
            }
        }

        @keyframes win {
            0% {
                transform: scale(1);
            }
            50% {
                transform:
                    rotate(2deg)
                    scale(0.85);
            }
        }

        @keyframes left-right {
            50% {
                transform: scaleX(0.4);
            }
        }

        @keyframes up-down {
            50% {
                transform: scaleY(0.4);
            }
        }

        @keyframes corners {
            50% {
                transform: scale(0.6);
            }
        }

        @keyframes wall {
            50% {
                transform: scale(0.7);
            }
        }

        @keyframes finish {
            50% {
                transform: scale(0.8);
            }
        }

        .player.turn-left,
        .player.turn-right {
            animation: left-right 0.3s ease;
        }

        .player.turn-up,
        .player.turn-down {
            animation: up-down 0.3s ease;
        }

        .player.turn-nw,
        .player.turn-ne,
        .player.turn-sw,
        .player.turn-se {
            animation: corners 0.3s ease;
        }

        .player.wall {
            border: 0.5em solid #ff4343;
            animation: wall 0.7s ease;
        }

        .player.finish {
            background-color: #ff4343;
            animation: finish 0.7s ease;
        }

        /* All elements */
        * {
            color: #000000;
            box-sizing: border-box;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        /* Elements by tag */
        html {
            align-content: center;
            background-color: #f1dac4;
            background-image: linear-gradient(60deg, #e9a2a2, transparent, #b2e0e7);
            background-attachment: fixed;
            height: 100%;
        }

        body {
            display: flex;
            background-color: transparent;
            flex-direction: column;
            margin: auto;
            font-size: 14pt;
            min-width: 40%;
            max-width: 90%;
        }

        @media (min-width: 720px) {
            body { max-width: 50%; }
        }

        a {
            background-color: transparent;
            color: #000000;
        }

        button,
        .pseudo-button {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            background-color: #e1e1e1;
            color: #000000;
            border: 2px outset #adadad;
            font-size: 1em;
            font-weight: 600;
            margin-block: 2px;
            padding: 2px;
            min-height: 1.7em;
        }

        button:disabled,
        .pseudo-button:disabled {
            background-color: #cccccc;
            color: #3d3d3d;
            cursor: not-allowed;
        }

        button:focus,
        button:hover,
        .pseudo-button:focus,
        .pseudo-button:hover {
            background-color: #e5f1fb;
            border-color: #0078D7;
        }

        details {
            background-color: #e1e1e1;
            border: 2px outset #adadad;
            margin-block: 2px;
            padding: 2px;
        }

        h1, h2, h3 {
            border-bottom: 3px inset #005499;
            border-radius: 2px;
            text-align: center;
            margin-block: 4px;
        }

        input[type='number'] {
            background-color: #fababa;
            font-size: 1em;
            font-weight: 600;
            text-align: center;
        }

        input[type='number']:focus,
        input[type='number']:hover {
            background-color: #e5f1fb;
        }

        select {
            background-color: #befdd6;
            color: #000000;
            border: 2px outset #adadad;
            border-radius: 0px;
            font-size: 1em;
            margin-block: 2px;
            padding-inline: 4px;
            min-height: 1.7em;
        }

        select:focus,
        select:hover {
            background-color: #e5f1fb;
            color: #000000;
            border-color: #005499;
        }

        select:focus > option,
        select:hover > option {
            background-color: #ffffff;
            color: #000000;
        }

        summary {
            font-weight: 600;
            cursor: pointer;
        }

        /* Elements by ID */
        #lang {
            margin-top: 4px;
        }

        #menu,
        #game,
        #levels,
        #blocks,
        #editor,
        #settings,
        #about {
            display: flex;
            flex-direction: column;
        }

        #game,
        #levels,
        #blocks,
        #editor,
        #settings,
        #about {
            display: none;
        }

        #author {
            background-color: #ffbbbb;
            color: #000000;
            border: 2px outset #c20000;
            text-align: center;
            font-size: 1em;
            margin-block: 2px;
            padding: 2px;
            cursor: help;
            width: 100%;
            opacity: 0.9;
        }

        #author:focus,
        #author:hover {
            background-color: #e5f1fb;
            border-color: #0078d7;
        }

        #load-div,
        #editor-load-div {
            display: flex;
        }

        #load-level,
        #editor-load-level {
            position: absolute;
            opacity: 0;
            max-width: 100%;
        }

        #save-level-button {
            cursor: default;
        }

        #shift-all-div {
            display: flex;
            flex-direction: row;
            align-items: center;
            column-gap: 2px;
            font-weight: 600;
            overflow: auto;
        }

        #shift-all-div > button {
            width: 2.5em;
            height: 2em;
            cursor: pointer;
        }

        #container {
            display: flex;
            flex-direction: row;
            justify-content: center;
            margin-block: 2px;
        }

        #grid {
            display: flex;
            flex-direction: column;
            row-gap: 1px;
            background-color: transparent;
            overflow: auto;
            margin-block: 4px;
            padding: 4px;
            border-radius: 8px;
            box-shadow: 0px 0px 8px #000000;
            max-height: 70vh;
        }

        #editor-div {
            display: flex;
            flex-direction: column;
        }

        #editor-grid-size,
        #editor-vector {
            display: flex;
            flex-direction: row;
            align-items: center;
            overflow: auto;
            column-gap: 6px;
            margin-block: 4px;
            font-weight: 600;
        }

        #editor-grid-size > div,
        #editor-vector > div {
            display: flex;
            flex-direction: row;
            align-items: center;
            column-gap: 2px;
        }

        #editor-grid-size > div > input[type='number'],
        #editor-vector > div > input[type='number'] {
            width: 3em;
        }

        #blocks-list {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            column-gap: 4px;
            row-gap: 4px;
            overflow: auto;
        }

        #blocks-list > button {
            column-gap: 4px;
            min-width: 15%;
            flex-grow: 1;
        }

        #blocks-list > button > div {
            min-width: 1.8em;
            min-height: 1.8em;
            max-width: 1.8em;
            max-height: 1.8em;
        }

        #blocks-list > button > .turn-up {
            border-top-width: 0.6em;
        }

        #blocks-list > button > .turn-down {
            border-bottom-width: 0.6em;
        }

        #blocks-list > button > .turn-left {
            border-left-width: 0.6em;
        }

        #blocks-list > button > .turn-right {
            border-right-width: 0.6em;
        }

        #blocks-list > button > .turn-nw {
            border-top-width: 0.6em;
            border-left-width: 0.6em;
        }

        #blocks-list > button > .turn-ne {
            border-top-width: 0.6em;
            border-right-width: 0.6em;
        }

        #blocks-list > button > .turn-sw {
            border-bottom-width: 0.6em;
            border-left-width: 0.6em;
        }

        #blocks-list > button > .turn-se {
            border-bottom-width: 0.6em;
            border-right-width: 0.6em;
        }

        /* Classes */
        .buttons-div {
            display: flex;
            flex-direction: row;
            overflow: auto;
            column-gap: 4px;
        }

        .buttons-div > button {
            width: 100%;
        }

        .editor-only {
            display: none;
        }

        .row {
            display: flex;
            background-color: transparent;
            column-gap: 1px;
        }

        .cell {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent;
            color: #000000;
            border: 0.12em solid #307fc0;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            min-width: 2.3em;
            min-height: 2.3em;
            max-width: 2.3em;
            max-height: 2.3em;
            cursor: cell;
            transition: all 2s ease;
        }

        .player {
            background-color: #ff4343;
            border: 0.12em solid #000000;
            transform: scale(0.9);
            transition: all 0s;
            cursor: progress;
        }

        .dir-up {
            border-top-width: 0.77em;
        }

        .dir-down {
            border-bottom-width: 0.77em;
        }

        .dir-left {
            border-left-width: 0.77em;
        }

        .dir-right {
            border-right-width: 0.77em;
        }

        .dir-nw {
            border-top-width: 0.77em;
            border-left-width: 0.77em;
        }

        .dir-ne {
            border-top-width: 0.77em;
            border-right-width: 0.77em;
        }

        .dir-sw {
            border-bottom-width: 0.77em;
            border-left-width: 0.77em;
        }

        .dir-se {
            border-bottom-width: 0.77em;
            border-right-width: 0.77em;
        }

        .wall {
            background-color: #000000;
            cursor: not-allowed;
        }

        .turn-up,
        .turn-down,
        .turn-left,
        .turn-right,
        .turn-nw,
        .turn-ne,
        .turn-sw,
        .turn-se {
            border: 0.12em solid #004985;
        }

        .turn-up {
            border-top-width: 0.77em;
            cursor: n-resize;
        }

        .turn-down {
            border-bottom-width: 0.77em;
            cursor: s-resize;
        }

        .turn-left {
            border-left-width: 0.77em;
            cursor: w-resize;
        }

        .turn-right {
            border-right-width: 0.77em;
            cursor: e-resize;
        }

        .turn-nw {
            border-top-width: 0.77em;
            border-left-width: 0.77em;
            cursor: nw-resize;
        }

        .turn-ne {
            border-top-width: 0.77em;
            border-right-width: 0.77em;
            cursor: ne-resize;
        }

        .turn-sw {
            border-bottom-width: 0.77em;
            border-left-width: 0.77em;
            cursor: sw-resize;
        }

        .turn-se {
            border-bottom-width: 0.77em;
            border-right-width: 0.77em;
            cursor: se-resize;
        }

        .finish {
            background-color: #a2ff89;
            border: 8px double #000000;
            border-radius: 50%;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- <a href='' id='exportLang' download='TranslationTemplate.json' onclick='exportTranslationTemplate()'>Export texts for translation</a> -->
    
    <!-- Main menu -->
    <div id='menu'>
        <h1 id='title'>Game</h1>

        <select id='lang'></select>

        <button id='start-button' onclick='switchScene("menu", "levels")'>
            Start game
        </button>
        <button id='editor-button' onclick='startGame("menu", true)'>
            Level editor
        </button>
        <button id='settings-button' onclick='switchScene("menu", "settings")'>
            Settings
        </button>
        <button id='about-button' onclick='switchScene("menu", "about")'>
            About
        </button>

        <!-- Author -->
        <p id='author' tabindex='0'>
            Made by <a href="https://github.com/VitalRus95">Vitaly Pavlovich Ulyanov (Vital)</a>.
        </p>
    </div>

    <!-- Levels div -->
    <div id='levels'>
        <button id='levels-back' onclick='switchScene("levels", "menu")'>
            Back
        </button>

        <h2 id='levels-title'>Levels</h2>

        <button id='continue' onclick='startGame("levels", false)' disabled>Continue</button>

        <div id='load-div' class='pseudo-button'>
            <label id='load-label' for='load-level'>Load level</label>
            <input id='load-level' type='file' accept='.json'>
        </div>
    </div>

    <!-- Game div -->
    <div id='game'>
        <button id='game-back' onclick='pauseGame()'>
            Back
        </button>

        <div id='editor-div' class='editor-only'>
            <div id='editor-load-div' class='pseudo-button'>
                <label id='editor-load-label' for='editor-load-level'>Load level</label>
                <input id='editor-load-level' type='file' accept='.json'>
            </div>

            <a id='save-level-button' class='pseudo-button' href=''>
                Save level
            </a>

            <!-- Level settings -->
            <details>
                <summary id='editor-tools-summary'>Level settings</summary>

                <!-- Grid size -->
                <div id='editor-grid-size'>
                    <span id='grid-size-label'>Grid size:</span>

                    <div>
                        <label for='size-x'>X</label>
                        <input type='number' id='size-x' min='5' max='50' value='5'>
                    </div>
                    <div>
                        <label for='size-y'>Y</label>
                        <input type='number' id='size-y' min='5' max='50' value='5'>
                    </div>
                </div>

                <!-- Player vector -->
                <div id='editor-vector'>
                    <span id='vector-label'>Player's vector:</span>

                    <div>
                        <label for='vector-x'>X</label>
                        <input type='number' id='vector-x' min='-1' max='1' value='0'>
                    </div>
                    <div>
                        <label for='vector-y'>Y</label>
                        <input type='number' id='vector-y' min='-1' max='1' value='1'>
                    </div>
                </div>

                <!-- Shift all -->
                <div id='shift-all-div'>
                    <label id='shift-all'>Shift blocks</label>

                    <button id='shift-n' class='turn-up' onclick='shiftAll("N")' >N</button>
                    <button id='shift-s' class='turn-down' onclick='shiftAll("S")' >S</button>
                    <button id='shift-e' class='turn-right' onclick='shiftAll("E")' >E</button>
                    <button id='shift-w' class='turn-left' onclick='shiftAll("W")' >W</button>
                </div>

                <!-- Player's direction -->
                <div></div>
            </details>
        </div>

        <div id='container'>
            <div id='grid'></div>
        </div>

        <div class='buttons-div'>
            <button id='launch'>Start</button>
            <button id='stop'>Stop</button>
            <button id='reset'>Reset</button>
        </div>
    </div>

    <!-- Blocks div -->
    <div id='blocks'>
        <button id='blocks-back' onclick='switchScene("blocks", "game")'>
            Return to game
        </button>

        <h2 id='blocks-title'>Blocks</h2>

        <div id='blocks-list'>
            <button id='blocks-player' class='editor-only' onclick='setCell(selected.x, selected.y, "player")'>
                Player
                <div class='cell player'></div>
            </button>

            <button id='blocks-finish' class='editor-only' onclick='setCell(selected.x, selected.y, "finish")'>
                Finish
                <div class='cell finish'></div>
            </button>

            <button id='blocks-empty' onclick='setCell(selected.x, selected.y, "cell")'>
                Empty
                <div class='cell'></div>
            </button>

            <button id='blocks-wall' class='editor-only' onclick='setCell(selected.x, selected.y, "wall")'>
                Wall
                <div class='cell wall'></div>
            </button>

            <button id='blocks-n' onclick='setCell(selected.x, selected.y, "turn-up")'>
                Turn N
                <div class='cell turn-up'></div>
            </button>

            <button id='blocks-s' onclick='setCell(selected.x, selected.y, "turn-down")'>
                Turn S
                <div class='cell turn-down'></div>
            </button>

            <button id='blocks-w' onclick='setCell(selected.x, selected.y, "turn-left")'>
                Turn W
                <div class='cell turn-left'></div>
            </button>

            <button id='blocks-e' onclick='setCell(selected.x, selected.y, "turn-right")'>
                Turn E
                <div class='cell turn-right'></div>
            </button>

            <button id='blocks-nw' onclick='setCell(selected.x, selected.y, "turn-nw")'>
                Turn NW
                <div class='cell turn-nw'></div>
            </button>

            <button id='blocks-ne' onclick='setCell(selected.x, selected.y, "turn-ne")'>
                Turn NE
                <div class='cell turn-ne'></div>
            </button>

            <button id='blocks-sw' onclick='setCell(selected.x, selected.y, "turn-sw")'>
                Turn SW
                <div class='cell turn-sw'></div>
            </button>

            <button id='blocks-se' onclick='setCell(selected.x, selected.y, "turn-se")'>
                Turn SE
                <div class='cell turn-se'></div>
            </button>
        </div>
    </div>

    <!-- Settings div -->
    <div id='settings'>
        <button id='settings-back' onclick='switchScene("settings", "menu")'>
            Back
        </button>

        <h2 id='settings-title'>Settings</h2>
    </div>

    <!-- About div -->
    <div id='about'>
        <button id='about-back' onclick='switchScene("about", "menu")'>
            Back
        </button>

        <h2 id='about-title'>About</h2>
    </div>

    <script>
        // Elements
        /** @type {HTMLDivElement} */
        let game = document.getElementById('game');
        /** @type {HTMLDivElement} */
        let grid = document.getElementById('grid');
        /** @type {HTMLButtonElement} */
        let continueButton = document.getElementById('continue');
        /** @type {HTMLButtonElement} */
        let launchButton = document.getElementById('launch');
        /** @type {HTMLButtonElement} */
        let stopButton = document.getElementById('stop');
        /** @type {HTMLButtonElement} */
        let resetButton = document.getElementById('reset');
        /** @type {HTMLAnchorElement} */
        let saveLevelButton = document.getElementById('save-level-button');
        /** @type {HTMLInputElement} */
        let sizeX = document.getElementById('size-x');
        /** @type {HTMLInputElement} */
        let sizeY = document.getElementById('size-y');
        /** @type {HTMLInputElement} */
        let vectorX = document.getElementById('vector-x');
        /** @type {HTMLInputElement} */
        let vectorY = document.getElementById('vector-y');
        /** @type {HTMLInputElement} */
        let loadLevel = document.getElementById('load-level');
        /** @type {HTMLInputElement} */
        let editorLoadLevel = document.getElementById('editor-load-level');

        // Variables
        /** @type {boolean} */
        let isInEditor = false;
        /** @type {number} */
        let moveInterval = null;
        /** @type {string} */
        let lastCellType = null;
        /** @type {{x: number, y: number}} */
        let selected = { x: 0, y: 0 };
        /** @type {{x: number, y: number}} */
        let player = { x: 0, y: 0 };
        /** @type {{x: number, y: number}} */
        let speed = { x: 0, y: 0 };
        /** @type {{
            gridSize: { x: number, y: number },
            start: { x: number, y: number },
            initSpeed: { x: number, y: number },
            blocks: { x: number, y: number, type: string }[]
        }}*/
        let level = {
            gridSize: { x: 5, y: 5},
            start: { x: 2, y: 2},
            initSpeed: { x: 0, y: 1 },
            blocks: []
        };

        continueButton.disabled = true;

        launchButton.addEventListener('click', function (event) {
            removePlayer();
            addPlayer(true);
            if (moveInterval === null) {
                moveInterval = setInterval(processMovement, 500);
                grid.style.animation = 'none';
            }
        });

        stopButton.addEventListener('click', function (event) {
            stopGameProcess();
            removePlayer();
            addPlayer(true);
        });

        resetButton.addEventListener('click', function (event) {
            stopGameProcess();
            fillGrid();
        });

        saveLevelButton.addEventListener('click', function (event) {
            if (!grid.hasChildNodes()) return;

            // Iterate over cells and save those with special classes
            saveGridBlocks();

            let data = encodeURIComponent(
                JSON.stringify(level, null, 2)
            );
            saveLevelButton.download = 'MyLevel.json';
            saveLevelButton.href = `data:text/plain;charset=utf-8,${data}`;
        });

        loadLevel.addEventListener('input', function (event) {
            loadLevelFromFile(event, loadLevel);
        });

        editorLoadLevel.addEventListener('input', function (event) {
            loadLevelFromFile(event, editorLoadLevel);
        });

        sizeX.addEventListener('click', function (event) {
            sizeX.focus();
        });

        sizeY.addEventListener('click', function (event) {
            sizeY.focus();
        });

        vectorX.addEventListener('click', function (event) {
            vectorX.focus();
        });

        vectorY.addEventListener('click', function (event) {
            vectorY.focus();
        });

        sizeX.addEventListener('blur', function (event) {
            level.gridSize.x = clamp(+sizeX.min, +sizeX.value, +sizeX.max);
            saveGridBlocks();
            fillGrid();
        });

        sizeY.addEventListener('blur', function (event) {
            level.gridSize.y = clamp(+sizeY.min, +sizeY.value, +sizeY.max);
            saveGridBlocks();
            fillGrid();
        });

        vectorX.addEventListener('blur', function (event) {
            level.initSpeed.x = clamp(+vectorX.min, +vectorX.value, +vectorX.max);
        });

        vectorY.addEventListener('blur', function (event) {
            level.initSpeed.y = clamp(+vectorY.min, +vectorY.value, +vectorY.max);
        });

        /**
         * @param {InputEvent} event
         * @param {HTMLInputElement} input
        */
        async function loadLevelFromFile(event, input) {
            await input.files[0].text().then((data) => {
                try {
                    level = JSON.parse(data);
                    input.value = '';
                } catch (error) {
                    alert(`Error while loading the level: ${error}`);
                    level = {
                        gridSize: { x: 5, y: 5},
                        start: { x: 2, y: 2},
                        initSpeed: { x: 0, y: 1 },
                        blocks: []
                    };
                } finally {
                    fillGrid();
                    if (input === loadLevel) {
                        startGame('levels', false);
                    }
                }
            });
        }

        function fillGrid() {
            // Reset everything
            while (grid.hasChildNodes()) grid.lastChild.remove();
            continueButton.disabled = false;
            clearInterval(moveInterval);

            // Set X and Y dimenstions in the editor
            sizeX.value = level.gridSize.x;
            sizeY.value = level.gridSize.y;

            // Create rows and cells
            for (let y = 0; y < level.gridSize.y; y++) {
                /** @type {HTMLDivElement} */
                let row = grid.appendChild(
                    document.createElement('div')
                );
                row.classList.add('row');

                for (let x = 0; x < level.gridSize.x; x++) {
                    /** @type {HTMLDivElement} */
                    let cell = row.appendChild(
                        document.createElement('div')
                    );
                    cell.classList.add('cell');
                    cell.tabIndex = 0;
                    cell.id = `${x};${y}`;
                    cell.addEventListener('keydown', function (event) {
                        switch (event.key) {
                            case 'ArrowUp':
                                event.preventDefault();
                                getCell(x, y - 1)?.focus();
                                break;
                            case 'ArrowDown':
                                event.preventDefault();
                                getCell(x, y + 1)?.focus();
                                break;
                            case 'ArrowLeft':
                                event.preventDefault();
                                getCell(x - 1, y)?.focus();
                                break;
                            case 'ArrowRight':
                                event.preventDefault();
                                getCell(x + 1, y)?.focus();
                                break;
                            case 'Enter':
                            case 'Space':
                                event.preventDefault();
                                if (isCellEditable(x, y)) {
                                    switchScene('game', 'blocks');
                                    selected.x = x;
                                    selected.y = y;
                                }
                                break;
                            default:
                                break;
                        }
                    });
                    cell.addEventListener('mouseup', function (event) {
                        event.preventDefault();
                        if (event.button === 2) { // Right mouse key
                            setCell(x, y, 'cell');
                        } else if (isCellEditable(x, y)) {
                            switchScene('game', 'blocks');
                                selected.x = x;
                                selected.y = y;
                        }
                    });
                    cell.addEventListener('mouseenter', function (event) {
                        if (event.shiftKey && lastCellType) {
                            setCell(x, y, lastCellType);
                        }
                    });
                    cell.addEventListener('contextmenu', function (event) {
                        event.preventDefault();
                        setCell(x, y, 'cell');
                    });
                }
            }

            // Add player
            removePlayer();
            addPlayer(true);

            // Fill special cells
            if (level.blocks) {
                for (let b of level.blocks) {
                    setCell(b.x, b.y, b.type);
                    getCell(b.x, b.y)?.classList.add('protected');
                }
            }
        }

        /**
         * @param {string} dir
        */
        function shiftAll(dir) {
            saveGridBlocks();
            removePlayer();

            /** @type {number} */
            let x = dir === 'E' ? 1 : dir === 'W' ? -1 : 0;
            /** @type {number} */
            let y = dir === 'S' ? 1 : dir === 'N' ? -1 : 0;

            level.start.x = ringClamp(0, level.start.x + x, level.gridSize.x - 1);
            level.start.y = ringClamp(0, level.start.y + y, level.gridSize.y - 1);

            for (const block of level.blocks) {
                block.x = ringClamp(0, block.x + x, level.gridSize.x - 1);
                block.y = ringClamp(0, block.y + y, level.gridSize.y - 1);
            }

            fillGrid();
        }

        function saveGridBlocks() {
            level.blocks = [];

            for (let y = 0; y < level.gridSize.y; y++) {
                for (let x = 0; x < level.gridSize.x; x++) {
                    /** @type {HTMLDivElement} */
                    let cell = getCell(x, y);

                    if (cell
                        && cell.classList.length > 1
                        && cell.classList.item(1) !== 'player'
                    ) {
                        level.blocks.push({
                            x: x,
                            y: y,
                            type: cell.classList.item(1)
                        });
                    }
                }
            }
        }

        /**
         * @param {number} x
         * @param {number} y
         * @param {string} type
        */
        function setCell(x, y, type) {
            /** @type {HTMLDivElement} */
            let cell = getCell(x, y);
            if (!cell || !isCellEditable(x, y)) return;

            cell.className = '';
            cell.classList.add('cell');

            switch (type) {
                case 'cell':
                    break;
                case 'player':
                    removePlayer();
                    player.x = x;
                    player.y = y;
                    level.start.x = x;
                    level.start.y = y;
                    addPlayer(false);
                    break; // Never forget `break;` like I did!
                default:
                    cell.classList.add(type);
                    if (isInEditor) cell.classList.add('protected');
                    break;
            }
            
            switchScene('blocks', 'game');
            if (type !== 'player' && type !== 'finish') {
                lastCellType = type;
            } else {
                lastCellType = null;
            }
        }

        /**
         * @param {number} x
         * @param {number} y
         * @returns {HTMLDivElement}
        */
        function getCell(x, y) {
            /** @type {HTMLDivElement} */
            let cell = document.getElementById(`${x};${y}`);
            return cell;
        }

        /**
         * @param {number} x
         * @param {number} y
         * @returns {boolean}
        */
        function isCellEditable(x, y) {
            /** @type {HTMLDivElement} */
            let cell = getCell(x, y);
            if (!cell) return false;
            return (
                isInEditor
                || (!cell.classList.contains('protected')
                    && !cell.classList.contains('player')
                    && !cell.classList.contains('finish'))
            );
        }

        /**
         * @param {boolean} resetPosition
         * @param {string} direction
        */
        function addPlayer(resetPosition, direction) {
            if (resetPosition) {
                player.x = level.start.x;
                player.y = level.start.y;
                speed.x = level.initSpeed.x;
                speed.y = level.initSpeed.y;
            }

            getCell(player.x, player.y)?.classList.add('player');
            
            /** @type {string} */
            let dir;

            if (speed.x === 0 && speed.y < 0) dir = 'dir-up';
            else if (speed.x === 0 && speed.y > 0) dir = 'dir-down';
            else if (speed.x < 0 && speed.y === 0) dir = 'dir-left';
            else if (speed.x > 0 && speed.y === 0) dir = 'dir-right';
            else if (speed.x < 0 && speed.y < 0) dir = 'dir-nw';
            else if (speed.x > 0 && speed.y < 0) dir = 'dir-ne';
            else if (speed.x < 0 && speed.y > 0) dir = 'dir-sw';
            else if (speed.x > 0 && speed.y > 0) dir = 'dir-se';

            if (dir) {
                getCell(player.x, player.y)?.classList.add(dir);
            }
        }

        function removePlayer() {
            getCell(player.x, player.y)?.classList.remove(
                'player', 'dir-up', 'dir-down', 'dir-left', 'dir-right',
                'dir-nw', 'dir-ne', 'dir-sw', 'dir-se'
            );
        }

        function stopGameProcess() {
            if (moveInterval) {
                clearInterval(moveInterval);
                moveInterval = null;
            }
        }

        function processMovement() {
            if (game.style.display === 'none') return;

            /** @type {HTMLDivElement} */
            let newCell = getCell(player.x, player.y);
            if (!newCell) return; // Should not be true but still
            
            // Wall collision
            if (newCell.classList.contains('wall')) {
                grid.style.animation = 'lose 0.6s ease';
                stopGameProcess();
                removePlayer();
                addPlayer(true);
                return;
            }

            // Finish reached
            if (newCell.classList.contains('finish')) {
                grid.style.animation = 'win 1s ease';
                stopGameProcess();
                removePlayer();
                return;
            }

            // Switch direction
            switch (newCell.classList.item(1)) {
                case 'turn-up':
                    speed.x = 0;
                    speed.y = -1;
                    break;
                case 'turn-down':
                    speed.x = 0;
                    speed.y = 1;
                    break;
                case 'turn-left':
                    speed.x = -1;
                    speed.y = 0;
                    break;
                case 'turn-right':
                    speed.x = 1;
                    speed.y = 0;
                    break;
                case 'turn-nw':
                    speed.x = -1;
                    speed.y = -1;
                    break;
                case 'turn-ne':
                    speed.x = 1;
                    speed.y = -1;
                    break;
                case 'turn-sw':
                    speed.x = -1;
                    speed.y = 1;
                    break;
                case 'turn-se':
                    speed.x = 1;
                    speed.y = 1;
                    break;
                default:
                    break;
            }

            // Continue moving
            removePlayer();
            player.x = ringClamp(0, player.x + speed.x, level.gridSize.x - 1);
            player.y = ringClamp(0, player.y + speed.y, level.gridSize.y - 1);
            addPlayer(false);
        }

        /**
         * @param {string} from
         * @param {boolean} editorMode
        */
        function startGame(from, editorMode) {
            lastCellType = null;
            isInEditor = editorMode;
            
            if (isInEditor === true) fillGrid();
            if (!moveInterval) addPlayer(true);

            for (let e of document.getElementsByClassName('editor-only')) {
                e.style.display = editorMode ? 'flex' : 'none';
            }
            switchScene(from, 'game');
        }

        function pauseGame() {
            if (isInEditor) saveGridBlocks();
            switchScene('game', isInEditor ? 'menu' : 'levels');
        }

        function switchScene(from, to) {
            if (from === to) return;
            if (from === 'game') grid.style.animation = 'none';

            try {
                document.getElementById(from).style.display = 'none';
                document.getElementById(to).style.display = 'flex';
            } catch (error) {
                console.log(error);
            }
        }

        /**
         * @param {number} min
         * @param {number} value
         * @param {number} max
         * @returns {number}
        */
        function ringClamp(min, value, max) {
            return value < min
                ? max
                : value > max
                    ? min
                    : value;
        }

        /**
         * @param {number} min
         * @param {number} value
         * @param {number} max
         * @returns {number}
        */
        function clamp(min, value, max) {
            return value < min
                ? min
                : value > max
                    ? max
                    : value;
        }

        generateLanguagesList([
            {
                name: 'English [Vitaly Ulyanov]',
                langTags: ['en', 'en-AU', 'en-BZ', 'en-CA', 'en-CB', 'en-GB', 'en-IE', 'en-JM', 'en-NZ', 'en-PH', 'en-TT', 'en-US', 'en-ZA', 'en-ZW'],
                elements: [
                    {
                        "id": "exportLang",
                        "childNodesTexts": [
                            "Export texts for translation"
                        ]
                    },
                    {
                        "id": "title",
                        "childNodesTexts": [
                            "Game"
                        ]
                    },
                    {
                        "id": "start-button",
                        "childNodesTexts": [
                            "Start game"
                        ]
                    },
                    {
                        "id": "editor-button",
                        "childNodesTexts": [
                            "Level editor"
                        ]
                    },
                    {
                        "id": "settings-button",
                        "childNodesTexts": [
                            "Settings"
                        ]
                    },
                    {
                        "id": "about-button",
                        "childNodesTexts": [
                            "About"
                        ]
                    },
                    {
                        "id": "author",
                        "childNodesTexts": [
                            "Made by ",
                            "Vitaly Pavlovich Ulyanov (Vital)",
                            "."
                        ]
                    },
                    {
                        "id": "levels-back",
                        "childNodesTexts": [
                            "Back"
                        ]
                    },
                    {
                        "id": "levels-title",
                        "childNodesTexts": [
                            "Levels"
                        ]
                    },
                    {
                        "id": "continue",
                        "childNodesTexts": [
                            "Continue"
                        ]
                    },
                    {
                        "id": "load-label",
                        "childNodesTexts": [
                            "Load level"
                        ]
                    },
                    {
                        "id": "game-back",
                        "childNodesTexts": [
                            "Back"
                        ]
                    },
                    {
                        "id": "editor-load-label",
                        "childNodesTexts": [
                            "Load level"
                        ]
                    },
                    {
                        "id": "save-level-button",
                        "childNodesTexts": [
                            "Save level"
                        ]
                    },
                    {
                        "id": "editor-tools-summary",
                        "childNodesTexts": [
                            "Level settings"
                        ]
                    },
                    {
                        "id": "grid-size-label",
                        "childNodesTexts": [
                            "Grid size:"
                        ]
                    },
                    {
                        "id": "shift-all",
                        "childNodesTexts": [
                            "Shift blocks"
                        ]
                    },
                    {
                        "id": "shift-n",
                        "childNodesTexts": [
                            "N"
                        ]
                    },
                    {
                        "id": "shift-s",
                        "childNodesTexts": [
                            "S"
                        ]
                    },
                    {
                        "id": "shift-e",
                        "childNodesTexts": [
                            "E"
                        ]
                    },
                    {
                        "id": "shift-w",
                        "childNodesTexts": [
                            "W"
                        ]
                    },
                    {
                        "id": "launch",
                        "childNodesTexts": [
                            "Start"
                        ]
                    },
                    {
                        "id": "stop",
                        "childNodesTexts": [
                            "Stop"
                        ]
                    },
                    {
                        "id": "reset",
                        "childNodesTexts": [
                            "Reset"
                        ]
                    },
                    {
                        "id": "blocks-back",
                        "childNodesTexts": [
                            "Return to game"
                        ]
                    },
                    {
                        "id": "blocks-title",
                        "childNodesTexts": [
                            "Blocks"
                        ]
                    },
                    {
                        "id": "blocks-player",
                        "childNodesTexts": [
                            "Player"
                        ]
                    },
                    {
                        "id": "blocks-finish",
                        "childNodesTexts": [
                            "Finish"
                        ]
                    },
                    {
                        "id": "blocks-empty",
                        "childNodesTexts": [
                            "Empty"
                        ]
                    },
                    {
                        "id": "blocks-wall",
                        "childNodesTexts": [
                            "Wall"
                        ]
                    },
                    {
                        "id": "blocks-n",
                        "childNodesTexts": [
                            "Turn N"
                        ]
                    },
                    {
                        "id": "blocks-s",
                        "childNodesTexts": [
                            "Turn S"
                        ]
                    },
                    {
                        "id": "blocks-w",
                        "childNodesTexts": [
                            "Turn W"
                        ]
                    },
                    {
                        "id": "blocks-e",
                        "childNodesTexts": [
                            "Turn E"
                        ]
                    },
                    {
                        "id": "blocks-nw",
                        "childNodesTexts": [
                            "Turn NW"
                        ]
                    },
                    {
                        "id": "blocks-ne",
                        "childNodesTexts": [
                            "Turn NE"
                        ]
                    },
                    {
                        "id": "blocks-sw",
                        "childNodesTexts": [
                            "Turn SW"
                        ]
                    },
                    {
                        "id": "blocks-se",
                        "childNodesTexts": [
                            "Turn SE"
                        ]
                    },
                    {
                        "id": "settings-back",
                        "childNodesTexts": [
                            "Back"
                        ]
                    },
                    {
                        "id": "settings-title",
                        "childNodesTexts": [
                            "Settings"
                        ]
                    },
                    {
                        "id": "about-back",
                        "childNodesTexts": [
                            "Back"
                        ]
                    },
                    {
                        "id": "about-title",
                        "childNodesTexts": [
                            "About"
                        ]
                    }
                ]
            },
            {
                name: 'Русский [Виталий Ульянов]',
                langTags: ['ru', 'ru-RU'],
                elements: [
                    {
                        "id": "exportLang",
                        "childNodesTexts": [
                            "Экспорт текстов для перевода"
                        ]
                    },
                    {
                        "id": "title",
                        "childNodesTexts": [
                            "Игра"
                        ]
                    },
                    {
                        "id": "start-button",
                        "childNodesTexts": [
                            "Начать игру"
                        ]
                    },
                    {
                        "id": "editor-button",
                        "childNodesTexts": [
                            "Редактор уровней"
                        ]
                    },
                    {
                        "id": "settings-button",
                        "childNodesTexts": [
                            "Настройки"
                        ]
                    },
                    {
                        "id": "about-button",
                        "childNodesTexts": [
                            "Об игре"
                        ]
                    },
                    {
                        "id": "author",
                        "childNodesTexts": [
                            "Автор — ",
                            "Виталий Павлович Ульянов (Vital)",
                            "."
                        ]
                    },
                    {
                        "id": "levels-back",
                        "childNodesTexts": [
                            "Назад"
                        ]
                    },
                    {
                        "id": "levels-title",
                        "childNodesTexts": [
                            "Уровни"
                        ]
                    },
                    {
                        "id": "continue",
                        "childNodesTexts": [
                            "Продолжить"
                        ]
                    },
                    {
                        "id": "load-label",
                        "childNodesTexts": [
                            "Загрузить уровень"
                        ]
                    },
                    {
                        "id": "game-back",
                        "childNodesTexts": [
                            "Назад"
                        ]
                    },
                    {
                        "id": "editor-load-label",
                        "childNodesTexts": [
                            "Загрузить уровень"
                        ]
                    },
                    {
                        "id": "save-level-button",
                        "childNodesTexts": [
                            "Сохранить уровень"
                        ]
                    },
                    {
                        "id": "editor-tools-summary",
                        "childNodesTexts": [
                            "Настройки уровня"
                        ]
                    },
                    {
                        "id": "grid-size-label",
                        "childNodesTexts": [
                            "Размер сетки:"
                        ]
                    },
                    {
                        "id": "shift-all",
                        "childNodesTexts": [
                            "Сдвиг блоков"
                        ]
                    },
                    {
                        "id": "shift-n",
                        "childNodesTexts": [
                            "С"
                        ]
                    },
                    {
                        "id": "shift-s",
                        "childNodesTexts": [
                            "Ю"
                        ]
                    },
                    {
                        "id": "shift-e",
                        "childNodesTexts": [
                            "В"
                        ]
                    },
                    {
                        "id": "shift-w",
                        "childNodesTexts": [
                            "З"
                        ]
                    },
                    {
                        "id": "launch",
                        "childNodesTexts": [
                            "Пуск"
                        ]
                    },
                    {
                        "id": "stop",
                        "childNodesTexts": [
                            "Стоп"
                        ]
                    },
                    {
                        "id": "reset",
                        "childNodesTexts": [
                            "Сброс"
                        ]
                    },
                    {
                        "id": "blocks-back",
                        "childNodesTexts": [
                            "Возврат к игре"
                        ]
                    },
                    {
                        "id": "blocks-title",
                        "childNodesTexts": [
                            "Блоки"
                        ]
                    },
                    {
                        "id": "blocks-player",
                        "childNodesTexts": [
                            "Игрок"
                        ]
                    },
                    {
                        "id": "blocks-finish",
                        "childNodesTexts": [
                            "Финиш"
                        ]
                    },
                    {
                        "id": "blocks-empty",
                        "childNodesTexts": [
                            "Пусто"
                        ]
                    },
                    {
                        "id": "blocks-wall",
                        "childNodesTexts": [
                            "Стена"
                        ]
                    },
                    {
                        "id": "blocks-n",
                        "childNodesTexts": [
                            "На С"
                        ]
                    },
                    {
                        "id": "blocks-s",
                        "childNodesTexts": [
                            "На Ю"
                        ]
                    },
                    {
                        "id": "blocks-w",
                        "childNodesTexts": [
                            "На З"
                        ]
                    },
                    {
                        "id": "blocks-e",
                        "childNodesTexts": [
                            "На В"
                        ]
                    },
                    {
                        "id": "blocks-nw",
                        "childNodesTexts": [
                            "На СЗ"
                        ]
                    },
                    {
                        "id": "blocks-ne",
                        "childNodesTexts": [
                            "На СВ"
                        ]
                    },
                    {
                        "id": "blocks-sw",
                        "childNodesTexts": [
                            "На ЮЗ"
                        ]
                    },
                    {
                        "id": "blocks-se",
                        "childNodesTexts": [
                            "На ЮВ"
                        ]
                    },
                    {
                        "id": "settings-back",
                        "childNodesTexts": [
                            "Назад"
                        ]
                    },
                    {
                        "id": "settings-title",
                        "childNodesTexts": [
                            "Настройки"
                        ]
                    },
                    {
                        "id": "about-back",
                        "childNodesTexts": [
                            "Назад"
                        ]
                    },
                    {
                        "id": "about-title",
                        "childNodesTexts": [
                            "Об игре"
                        ]
                    }
                ]
            }
        ]);

        /**
         * @typedef {Object} Translation
         * @property {string} name
         * @property {string[]} langTags
         * @property {LangElement[]} elements
         */
        /**
         * @param {Translation[]} languages
         */
        function generateLanguagesList(languages) {
            /** @type {HTMLSelectElement} */
            let list = document.getElementById('lang');
            list.addEventListener('change', function (event) {
                selectLanguage(languages, true);
            });

            for (let l of languages) {
                /** @type {HTMLOptionElement} */
                let option = list.appendChild(
                    document.createElement('option')
                );
                option.value = l.name;
                option.textContent = l.name;
            }

            selectLanguage(languages, false);
        }

        /**
         * @param {Translation[]} languages
         * @param {boolean} fromMenu
         */
        function selectLanguage(languages, fromMenu) {
            /** @type {HTMLSelectElement} */
            let menu = document.getElementById('lang');
            /** @type {string} */
            let selection = null;

            if (!fromMenu) {
                if (localStorage.getItem('lang')) {
                    selection = localStorage.getItem('lang');
                    menu.value = selection;
                } else if (navigator.language) {
                    // Iterate over translations
                    for (let l of languages) {
                        // If the valid option is finally found, exit
                        if (selection) {
                            break;
                        } else if (l.langTags) {
                            // Otherwise iterate over the tags and
                            // compare them to the browser language
                            for (let t of l.langTags) {
                                if (navigator.language === t) {
                                    menu.value = l.name;
                                    selection = l.name;
                                    break;
                                }
                            }
                        }
                    }
                }
            } else {
                selection = menu.value;
            }

            if (selection) {
                /** @type {Translation} */
                let translation = {};

                for (let l of languages) {
                    if (l.name === selection) {
                        translation = l;
                        break;
                    }
                }

                if (translation) {
                    localStorage.setItem('lang', selection);

                    for (let e of translation.elements) {
                        let target = document.getElementById(e.id);

                        if (target) {
                            if (e.textContent) {
                                target.textContent = e.textContent;
                            }

                            if (e.placeholder) {
                                target.placeholder = e.placeholder;
                            }

                            if (e.childNodesTexts) {
                                /** @type {number} */
                                let index = 0;

                                for (let c of target.childNodes) {
                                    if (c.textContent
                                        && c.textContent.trim() !== ''
                                        && e.childNodesTexts[index]
                                    ) {
                                        c.textContent = e.childNodesTexts[index];
                                        index ++;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    
        /**
         * @typedef {Object} LangElement
         * @property {string} id
         * @property {string} textContent
         * @property {string} placeholder
         * @property {string[]} childNodesTexts
         */
        function exportTranslationTemplate() {
            /** @type {LangElement[]} */
            let elements = [];

            document.querySelectorAll('body *').forEach((e) => {
                if (e.tagName !== 'DIV'
                    && e.tagName !== 'DETAILS'
                    && e.tagName !== 'TABLE'
                    && e.id
                    && e.id !== 'lang'
                ) {
                    /** @type {LangElement} */
                    let newEl = {};

                    newEl.id = e.id;

                    if (e.childNodes) {
                        newEl.childNodesTexts = [];

                        for (let n of e.childNodes) {
                            if (n.textContent && n.textContent.trim() !== '') {
                                newEl.childNodesTexts.push(n.textContent.trim());
                            }
                        }
                    } else {
                        if (e.textContent) {
                            newEl.textContent = e.textContent;
                        }
                    }

                    if (e.placeholder) {
                        newEl.placeholder = e.placeholder;
                    }

                    if (newEl.textContent
                        || newEl.placeholder
                        || newEl?.childNodesTexts.length > 0
                    ) {
                        elements.push(newEl);
                    }
                }
            });

            let data = encodeURIComponent(JSON.stringify(elements, null, 4));
            exportLang.href = `data:text/plain;charset=utf-8,${data}`;
        }
    </script>
</body>
</html>
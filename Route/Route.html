<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Route</title>
    <style>
        /* Animations */
        @keyframes lose {
            33% {
                transform: translateX(-5%);
            }
            66% {
                transform: translateX(5%);
            }
        }

        @keyframes win {
            0% {
                transform: scale(1);
            }
            50% {
                transform:
                    rotate(2deg)
                    scale(0.85);
            }
        }

        @keyframes left-right {
            50% {
                transform: scaleX(0.4);
            }
        }

        @keyframes up-down {
            50% {
                transform: scaleY(0.4);
            }
        }

        @keyframes corners {
            50% {
                transform: scale(0.6);
            }
        }

        @keyframes wall {
            50% {
                transform: scale(0.7);
            }
        }

        @keyframes finish {
            50% {
                transform: scale(0.8);
            }
        }

        .player.turn-left,
        .player.turn-right {
            animation: left-right 0.3s ease;
        }

        .player.turn-up,
        .player.turn-down {
            animation: up-down 0.3s ease;
        }

        .player.turn-nw,
        .player.turn-ne,
        .player.turn-sw,
        .player.turn-se {
            animation: corners 0.3s ease;
        }

        .player.wall {
            border: 0.3em solid var(--player);
            animation: wall 0.7s ease;
        }

        .player.jump {
            background-color: var(--player);
            transform: scale(0.5);
            transition: all 0.4s ease;
        }

        .player.teleport {
            background-color: var(--player);
            transform: scale(0.1);
            transition: all 0.3s ease;
        }

        .player.finish {
            background-color: var(--player);
            animation: finish 0.7s ease;
        }

        /* All elements */
        :root {
            --grey-bgr: #e1e1e1;
            --grey-border: #adadad;
            --heading: #005499;
            --inputs: #befdd6;
            --player: #ff4343;
            --player-border: #590000;
            --blue-hover: #e5f1fb;
            --blue-hover-border: #0078d7;
        }
        
        * {
            color: #000000;
            box-sizing: border-box;
            -moz-box-sizing: border-box;
            -webkit-box-sizing: border-box;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        /* Elements by tag */
        html {
            align-content: center;
            background-color: #f1dac4;
            background-image: linear-gradient(60deg, #e9a2a2, transparent, #b2e0e7);
            background-attachment: fixed;
            height: 100%;
        }

        body {
            display: flex;
            background-color: transparent;
            flex-direction: column;
            margin: auto;
            font-size: 14pt;
            min-width: 40%;
            max-width: 90%;
        }

        @media (min-width: 720px) {
            body { max-width: 60%; }
        }

        a {
            background-color: transparent;
            color: #000000;
        }

        button,
        .pseudo-button {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            text-decoration: none;
            background-color: var(--grey-bgr);
            color: #000000;
            border: 2px outset var(--grey-border);
            font-size: 1em;
            font-weight: 600;
            margin-block: 2px;
            padding: 2px;
            min-height: 1.7em;
        }

        button:disabled,
        .pseudo-button:disabled {
            background-color: #cccccc;
            color: #3d3d3d;
            cursor: not-allowed;
        }

        button:focus,
        button:hover,
        .pseudo-button:focus,
        .pseudo-button:hover {
            background-color: var(--blue-hover);
            border-color: var(--blue-hover-border);
        }

        caption {
            font-size: 1.1em;
            font-style: italic;
            font-weight: 600;
        }

        details {
            background-color: var(--grey-bgr);
            border: 2px outset var(--grey-border);
            margin-block: 2px;
            padding: 2px;
        }

        h1, h2, h3 {
            border-bottom: 3px inset var(--heading);
            border-radius: 2px;
            text-align: center;
            margin-block: 4px;
        }

        h1 {
            font-size: 1.9em;
        }

        h2 {
            font-size: 1.5em;
        }

        h3 {
            font-size: 1.25em;
        }

        hr {
            border-style: none;
            border-top: 4px double var(--heading);
            margin-block: 4px;
            width: 100%;
        }

        input {
            background-color: var(--inputs);
            border: 2px outset var(--grey-border);
            font-size: 1em;
        }

        input:focus,
        input:hover {
            background-color: var(--blue-hover);
            border-color: var(--blue-hover-border);
        }

        select {
            background-color: var(--inputs);
            color: #000000;
            border: 2px outset var(--grey-border);
            border-radius: 0px;
            font-size: 1em;
            margin-block: 2px;
            padding-inline: 4px;
            min-height: 1.7em;
        }

        select:focus,
        select:hover {
            background-color: var(--blue-hover);
            color: #000000;
            border-color: var(--heading);
        }

        select:focus > option,
        select:hover > option {
            background-color: #ffffff;
            color: #000000;
        }

        summary {
            font-weight: 600;
            cursor: pointer;
        }

        table {
            border-collapse: collapse;
            margin-block: 4px;
            width: 100%;
        }

        td, th {
            border: 2px outset #004985;
            padding-inline: 2px;
        }

        tr {
            background-color: var(--blue-hover);
        }

        tr:nth-of-type(even) {
            background-color: #ffbbbb;
        }

        tr:focus,
        tr:hover {
            background-color: #d3d3d3;
            border: 2px dashed #004985;
        }

        /* Elements by ID */
        #lang {
            margin-top: 4px;
        }

        #menu,
        #game,
        #stats,
        #levels,
        #blocks,
        #editor,
        #settings,
        #about {
            display: flex;
            flex-direction: column;
        }

        #game,
        #stats,
        #levels,
        #blocks,
        #editor,
        #settings,
        #about {
            display: none;
        }

        #author {
            background-color: #ffbbbb;
            color: #000000;
            border: 2px outset #c20000;
            text-align: center;
            font-size: 1em;
            margin-block: 2px;
            padding: 2px;
            cursor: help;
            width: 100%;
            opacity: 0.9;
        }

        #set-player-symbol {
            max-width: 3em;
        }

        #author:focus,
        #author:hover {
            background-color: var(--blue-hover);
            border-color: var(--blue-hover-border);
        }

        #load-div,
        #editor-load-div {
            display: flex;
        }

        #load-level,
        #editor-load-level {
            position: absolute;
            opacity: 0;
            max-width: 100%;
        }

        #save-level-button {
            cursor: default;
        }

        #shift-all-div {
            display: flex;
            flex-direction: row;
            align-items: center;
            column-gap: 2px;
            font-weight: 600;
            overflow: auto;
        }

        #shift-all-div > button {
            width: 2.5em;
            height: 2em;
            cursor: pointer;
        }

        #stats-steps-value,
        #stats-blocks-value {
            text-align: center;
            font-weight: 600;
        }

        #container {
            display: flex;
            flex-direction: row;
            justify-content: center;
            margin-block: 2px;
        }

        #grid {
            display: flex;
            flex-direction: column;
            row-gap: 1px;
            background-color: transparent;
            overflow: auto scroll;
            margin-block: 4px;
            padding: 4px;
            border-radius: 8px;
            box-shadow: 0px 0px 8px #000000;
            max-height: 70vh;
        }

        #editor-div {
            display: flex;
            flex-direction: column;
        }

        #editor-grid-size,
        #editor-vector {
            display: flex;
            flex-direction: row;
            align-items: center;
            overflow: auto;
            column-gap: 6px;
            margin-block: 4px;
            font-weight: 600;
        }

        #editor-grid-size > div,
        #editor-vector > div {
            display: flex;
            flex-direction: row;
            align-items: center;
            column-gap: 2px;
        }

        #editor-grid-size > div > input[type='number'],
        #editor-vector > div > input[type='number'] {
            width: 3em;
        }

        #blocks-list {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            column-gap: 4px;
            row-gap: 4px;
            overflow: auto;
        }

        #blocks-list > button {
            column-gap: 4px;
            min-width: 15%;
            flex-grow: 1;
        }

        #blocks-list > button > div {
            min-width: 1.35em;
            min-height: 1.35em;
            max-width: 1.35em;
            max-height: 1.35em;
        }

        #blocks-list > button > .turn-up {
            border-top-width: 0.45em;
        }

        #blocks-list > button > .turn-down {
            border-bottom-width: 0.45em;
        }

        #blocks-list > button > .turn-left {
            border-left-width: 0.45em;
        }

        #blocks-list > button > .turn-right {
            border-right-width: 0.45em;
        }

        #blocks-list > button > .turn-nw {
            border-top-width: 0.45em;
            border-left-width: 0.45em;
        }

        #blocks-list > button > .turn-ne {
            border-top-width: 0.45em;
            border-right-width: 0.45em;
        }

        #blocks-list > button > .turn-sw {
            border-bottom-width: 0.45em;
            border-left-width: 0.45em;
        }

        #blocks-list > button > .turn-se {
            border-bottom-width: 0.45em;
            border-right-width: 0.45em;
        }

        #blocks-list > button > .teleport {
            border-width: 0.3375em;
        }

        /* Classes */
        .buttons-div {
            display: flex;
            flex-direction: row;
            overflow: auto;
            column-gap: 4px;
        }

        .buttons-div > button {
            width: 100%;
        }

        .settings-list {
            display: flex;
            flex-direction: column;
            margin-block: 4px;
            row-gap: 2px;
        }

        .editor-only {
            display: none;
        }

        .episode {
            display: flex;
            flex-direction: column;
            border: 2px inset #747474;
            border-radius: 2px;
            border-top-style: none;
            margin-top: 0px;
            padding-block: 2px;
            padding-inline: 4px;
        }

        .episode > button {
            justify-content: left;
            padding-left: 2%;
        }

        .row {
            display: flex;
            background-color: transparent;
            column-gap: 1px;
        }

        .cell {
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent;
            color: #000000;
            border: 0.09em solid #307fc0;
            border-radius: 8px;
            font-size: 1.4em;
            font-weight: 600;
            min-width: 1.65em;
            min-height: 1.65em;
            max-width: 1.65em;
            max-height: 1.65em;
            cursor: cell;
            transition: all 2s ease;
        }

        .cell:focus {
            box-shadow: 0px 0px 0px 0.2em #9d0000;
            outline-style: none;
            transition: all 0s ease;
        }

        .player {
            background-color: var(--player);
            border: 0.12em solid var(--player-border);
            transform: scale(0.9);
            transition: all 0s;
            cursor: progress;
        }

        .dir-up {
            border-top-width: 0.3em;
        }

        .dir-down {
            border-bottom-width: 0.3em;
        }

        .dir-left {
            border-left-width: 0.3em;
        }

        .dir-right {
            border-right-width: 0.3em;
        }

        .dir-nw {
            border-top-width: 0.3em;
            border-left-width: 0.3em;
        }

        .dir-ne {
            border-top-width: 0.3em;
            border-right-width: 0.3em;
        }

        .dir-sw {
            border-bottom-width: 0.3em;
            border-left-width: 0.3em;
        }

        .dir-se {
            border-bottom-width: 0.3em;
            border-right-width: 0.3em;
        }

        .wall {
            background-color: #000000;
            cursor: not-allowed;
        }

        .turn-up,
        .turn-down,
        .turn-left,
        .turn-right,
        .turn-nw,
        .turn-ne,
        .turn-sw,
        .turn-se {
            border: 0.12em solid #004985;
        }

        .turn-up {
            border-top-width: 0.55em;
            cursor: n-resize;
        }

        .turn-down {
            border-bottom-width: 0.55em;
            cursor: s-resize;
        }

        .turn-left {
            border-left-width: 0.55em;
            cursor: w-resize;
        }

        .turn-right {
            border-right-width: 0.55em;
            cursor: e-resize;
        }

        .turn-nw {
            border-top-width: 0.55em;
            border-left-width: 0.55em;
            cursor: nw-resize;
        }

        .turn-ne {
            border-top-width: 0.55em;
            border-right-width: 0.55em;
            cursor: ne-resize;
        }

        .turn-sw {
            border-bottom-width: 0.55em;
            border-left-width: 0.55em;
            cursor: sw-resize;
        }

        .turn-se {
            border-bottom-width: 0.55em;
            border-right-width: 0.55em;
            cursor: se-resize;
        }

        .jump {
            background-color: #f1ff30;
            border: 0.3em double #590000;
            cursor: move;
            transition: all 0.2s ease;
        }

        .teleport {
            background-color: #6c85ff;
            border: 0.4125em ridge #e66d59;
            transition: all 0.4s ease;
        }

        .finish {
            background-color: #a2ff89;
            border: 0.3em double #000000;
            border-radius: 50%;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- <a href='' id='exportLang' download='TranslationTemplate.json' onclick='exportTranslationTemplate()'>Export texts for translation</a> -->
    
    <!-- Main menu div -->
    <div id='menu' tabindex='1'>
        <h1 id='title'>Route</h1>

        <select id='lang' tabindex='0'></select>

        <button id='start-button' tabindex='1' onclick='switchScene("menu", "levels")'>
            Play
        </button>
        <button id='editor-button' tabindex='1' onclick='startGame("menu", true)'>
            Level editor
        </button>
        <button id='settings-button' tabindex='1' onclick='switchScene("menu", "settings")'>
            Settings
        </button>
        <button id='about-button' tabindex='1' onclick='switchScene("menu", "about")'>
            About
        </button>

        <!-- Author -->
        <p id='author' tabindex='0'>
            Made by <a href="https://github.com/VitalRus95">Vitaly Pavlovich Ulyanov (Vital)</a>.
        </p>
    </div>

    <!-- Levels div -->
    <div id='levels' tabindex='0'>
        <h2 id='levels-title'>Levels</h2>

        <button id='levels-back' onclick='switchScene("levels", "menu")'>
            Back
        </button>

        <button id='continue'>Continue</button>

        <button id='nextLevelFromMenu' onclick='nextStandardLevel()'>Next level</button>

        <div id='load-div' class='pseudo-button'>
            <label id='load-label' for='load-level'>Load level</label>
            <input id='load-level' type='file' accept='.json'>
        </div>

        <!-- Standard levels -->
        <h2 id='e1'>1. Theory</h2>
        <div class='episode'>
            <button id='e1m1' onclick='loadStandardLevel(this, 0, 0)'>1.1. Your goal is here</button>
            <button id='e1m2' onclick='loadStandardLevel(this, 0, 1)'>1.2. Over the edge</button>
            <button id='e1m3' onclick='loadStandardLevel(this, 0, 2)'>1.3. New turn</button>
            <button id='e1m4' onclick='loadStandardLevel(this, 0, 3)'>1.4. Teleportation</button>
            <button id='e1m5' onclick='loadStandardLevel(this, 0, 4)'>1.5. Diagonal</button>
        </div>

        <h2 id='e2'>2. Practice</h2>
        <div class='episode'>
            <button id='e2m1' onclick='loadStandardLevel(this, 1, 0)'>2.1. Tiny wall</button>
            <button id='e2m2' onclick='loadStandardLevel(this, 1, 1)'>2.2. Breach</button>
            <button id='e2m3' onclick='loadStandardLevel(this, 1, 2)'>2.3. Neighbours</button>
        </div>

        <h2 id='e3'>3. Creativity</h2>
        <div class='episode'>
            <button id='e3m1' onclick='loadStandardLevel(this, 2, 0)'>3.1. Pipes</button>
            <button id='e3m2' onclick='loadStandardLevel(this, 2, 1)'>3.2. Robot</button>
        </div>
    </div>

    <!-- Game div -->
    <div id='game' tabindex='0'>
        <h3 id='level-title'></h3>

        <button id='game-back' onclick='pauseGame()'>
            Back
        </button>

        <!-- Statistics -->
        <div id='stats' tabindex='0'>
            <button id='nextLevelFromStats' onclick='nextStandardLevel()'>Next level</button>

            <table>
                <caption id='stats-label' tabindex='0'>Victory!</caption>

                <tbody>
                    <tr>
                        <td id='stats-steps-label' tabindex='0'>Steps taken</td>
                        <td id='stats-steps-value' tabindex='0'></td>
                    </tr>

                    <tr>
                        <td id='stats-blocks-label' tabindex='0'>Blocks used</td>
                        <td id='stats-blocks-value' tabindex='0'></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Editor -->
        <div id='editor-div' class='editor-only'>
            <div id='editor-load-div' class='pseudo-button'>
                <label id='editor-load-label' for='editor-load-level'>Load level</label>
                <input id='editor-load-level' type='file' accept='.json'>
            </div>

            <a id='save-level-button' class='pseudo-button' href=''>
                Save level
            </a>

            <!-- Level settings -->
            <details open>
                <summary id='editor-tools-summary'>Level settings</summary>

                <!-- Grid size -->
                <div id='editor-grid-size'>
                    <span id='grid-size-label'>Grid size:</span>

                    <div>
                        <label for='size-x'>X</label>
                        <input type='number' id='size-x' min='5' max='50' value='5'>
                    </div>
                    <div>
                        <label for='size-y'>Y</label>
                        <input type='number' id='size-y' min='5' max='50' value='5'>
                    </div>
                </div>

                <!-- Player vector -->
                <div id='editor-vector'>
                    <label for='vector-menu' id='vector-label'>Player's vector:</label>

                    <select name='vector-select' id='vector-menu'>
                        <option value='dir-up'>North (N)</option>
                        <option value='dir-down' selected>South (S)</option>
                        <option value='dir-right'>East (E)</option>
                        <option value='dir-left'>West (W)</option>
                        <option value='dir-ne'>Northeast (NE)</option>
                        <option value='dir-se'>Southeast (SE)</option>
                        <option value='dir-sw'>Southwest (SW)</option>
                        <option value='dir-nw'>Northwest (NW)</option>
                    </select>
                </div>

                <!-- Shift all -->
                <div id='shift-all-div'>
                    <label id='shift-all'>Shift blocks</label>

                    <button id='shift-n' class='turn-up' onclick='shiftAll("N")' >N</button>
                    <button id='shift-s' class='turn-down' onclick='shiftAll("S")' >S</button>
                    <button id='shift-e' class='turn-right' onclick='shiftAll("E")' >E</button>
                    <button id='shift-w' class='turn-left' onclick='shiftAll("W")' >W</button>
                </div>

                <!-- Copy last type on click -->
                <div>
                    <input type='checkbox' id='copy-last'>
                    <label for='copy-last' id='copy-last-label'>Copy last block on click</label>
                </div>
            </details>
        </div>

        <div id='container'>
            <div id='grid'></div>
        </div>

        <div class='buttons-div'>
            <button id='launch'>Start</button>
            <button id='stop'>Stop</button>
            <button id='reset'>Reset</button>
        </div>
    </div>

    <!-- Blocks div -->
    <div id='blocks' tabindex='0'>
        <h2 id='blocks-title'>Blocks</h2>

        <button id='blocks-back' onclick='switchScene("blocks", "game")'>
            Return to game
        </button>

        <hr>

        <div id='blocks-list'>
            <button id='blocks-player' class='editor-only' onclick='setCellAndReturn(selected.x, selected.y, "player")'>
                Player
                <div class='cell player'></div>
            </button>

            <button id='blocks-finish' class='editor-only' onclick='setCellAndReturn(selected.x, selected.y, "finish")'>
                Finish
                <div class='cell finish'></div>
            </button>

            <button id='blocks-empty' onclick='setCellAndReturn(selected.x, selected.y, "cell")'>
                Empty
                <div class='cell'></div>
            </button>

            <button id='blocks-wall' class='editor-only' onclick='setCellAndReturn(selected.x, selected.y, "wall")'>
                Wall
                <div class='cell wall'></div>
            </button>

            <button id='blocks-jump' onclick='setCellAndReturn(selected.x, selected.y, "jump")'>
                Jump
                <div class='cell jump'></div>
            </button>

            <button id='blocks-teleport' onclick='setCellAndReturn(selected.x, selected.y, "teleport")'>
                To start
                <div class='cell teleport'></div>
            </button>

            <button id='blocks-n' onclick='setCellAndReturn(selected.x, selected.y, "turn-up")'>
                Turn N
                <div class='cell turn-up'></div>
            </button>

            <button id='blocks-s' onclick='setCellAndReturn(selected.x, selected.y, "turn-down")'>
                Turn S
                <div class='cell turn-down'></div>
            </button>

            <button id='blocks-e' onclick='setCellAndReturn(selected.x, selected.y, "turn-right")'>
                Turn E
                <div class='cell turn-right'></div>
            </button>

            <button id='blocks-w' onclick='setCellAndReturn(selected.x, selected.y, "turn-left")'>
                Turn W
                <div class='cell turn-left'></div>
            </button>

            <button id='blocks-ne' onclick='setCellAndReturn(selected.x, selected.y, "turn-ne")'>
                Turn NE
                <div class='cell turn-ne'></div>
            </button>

            <button id='blocks-se' onclick='setCellAndReturn(selected.x, selected.y, "turn-se")'>
                Turn SE
                <div class='cell turn-se'></div>
            </button>

            <button id='blocks-sw' onclick='setCellAndReturn(selected.x, selected.y, "turn-sw")'>
                Turn SW
                <div class='cell turn-sw'></div>
            </button>

            <button id='blocks-nw' onclick='setCellAndReturn(selected.x, selected.y, "turn-nw")'>
                Turn NW
                <div class='cell turn-nw'></div>
            </button>
        </div>
    </div>

    <!-- Settings div -->
    <div id='settings' tabindex='0'>
        <h2 id='settings-title'>Settings</h2>

        <button id='settings-back' onclick='switchScene("settings", "menu")'>
            Back
        </button>

        <div id='settings-player' class='cell player dir-ne'></div>
        <hr>

        <ul class='settings-list'>
            <li><div class='setting-div'>
                <label for='set-player-symbol' id='player-symbol-label'>Player's symbol</label>
                <input type='text' id='set-player-symbol'>
            </div></li>

            <li><div class='setting-div'>
                <label for='set-player-colour' id='player-colour-label'>Player's colour</label>
                <input type='color' id='set-player-colour' value='#ff4343'>
            </div></li>

            <li><div class='setting-div'>
                <label for='set-player-border-colour' id='player-border-colour-label'>Player's border colour</label>
                <input type='color' id='set-player-border-colour' value='#590000'>
            </div></li>

            <li><div class='setting-div'>
                <label for='set-game-speed' id='game-speed-label'>Step interval (in milliseconds)</label>
                <input type='number' id='set-game-speed' min='200' max='3000' step='100' value='500'>
            </div></li>

            <li><div class='setting-div'>
                <label for='set-game-volume' id='game-volume-label'>Sound volume</label>
                <input type='number' id='set-game-volume' min='0' max='1' step='0.1' value='0.5'>
            </div></li>
        </ul>

        <button id='default-settings'>Restore default settings</button>
    </div>

    <!-- About div -->
    <div id='about' tabindex='0'>
        <h2 id='about-title'>About</h2>

        <button id='about-back' onclick='switchScene("about", "menu")'>
            Back
        </button>

        <p>Game description. To be continued...</p>
    </div>

    <script>
        // Elements
        /** @type {HTMLDivElement} */
        let menu = document.getElementById('menu');
        /** @type {HTMLDivElement} */
        let levels = document.getElementById('levels');
        /** @type {HTMLDivElement} */
        let game = document.getElementById('game');
        /** @type {HTMLDivElement} */
        let stats = document.getElementById('stats');
        /** @type {HTMLTableDataCellElement} */
        let statsSteps = document.getElementById('stats-steps-value');
        /** @type {HTMLTableDataCellElement} */
        let statsBlocks = document.getElementById('stats-blocks-value');
        /** @type {HTMLDivElement} */
        let blocks = document.getElementById('blocks');
        /** @type {HTMLDivElement} */
        let settings = document.getElementById('settings');
        /** @type {HTMLDivElement} */
        let about = document.getElementById('about');

        /** @type {HTMLDivElement} */
        let settingsPlayer = document.getElementById('settings-player');
        /** @type {HTMLInputElement} */
        let playerSymbol = document.getElementById('set-player-symbol');
        /** @type {HTMLInputElement} */
        let playerColour = document.getElementById('set-player-colour');
        /** @type {HTMLInputElement} */
        let playerBorderColour = document.getElementById('set-player-border-colour');
        /** @type {HTMLInputElement} */
        let gameSpeed = document.getElementById('set-game-speed');
        /** @type {HTMLInputElement} */
        let gameVolume = document.getElementById('set-game-volume');
        /** @type {HTMLButtonElement} */
        let defaultSettings = document.getElementById('default-settings');

        /** @type {HTMLHeadingElement} */
        let levelTitle = document.getElementById('level-title');
        /** @type {HTMLDivElement} */
        let grid = document.getElementById('grid');
        /** @type {HTMLButtonElement} */
        let continueButton = document.getElementById('continue');
        /** @type {HTMLButtonElement} */
        let launchButton = document.getElementById('launch');
        /** @type {HTMLButtonElement} */
        let stopButton = document.getElementById('stop');
        /** @type {HTMLButtonElement} */
        let resetButton = document.getElementById('reset');

        /** @type {HTMLAnchorElement} */
        let saveLevelButton = document.getElementById('save-level-button');
        /** @type {HTMLInputElement} */
        let sizeX = document.getElementById('size-x');
        /** @type {HTMLInputElement} */
        let sizeY = document.getElementById('size-y');
        /** @type {HTMLSelectElement} */
        let vectorMenu = document.getElementById('vector-menu');
        /** @type {HTMLInputElement} */
        let copyLast = document.getElementById('copy-last');
        /** @type {HTMLInputElement} */
        let loadLevel = document.getElementById('load-level');
        /** @type {HTMLInputElement} */
        let editorLoadLevel = document.getElementById('editor-load-level');

        // Objects
        /**
         * @param {{ x: number, y: number }} gridSize
         * @param {{ x: number, y: number }} start
         * @param {{ x: number, y: number }} initSpeed
         * @param {{ x: number, y: number, type: string }[]} blocks
        */
        function Level(gridSize, start, initSpeed, blocks) {
            this.gridSize = gridSize;
            this.start = start;
            this.initSpeed = initSpeed;
            this.blocks = blocks;
        }

        let player = {
            x: 0,
            y: 0,
            get cell() {
                return getCell(this.x, this.y);
            },
            /**
             * @param {boolean} resetPos
            */
            create(reset) {
                if (reset) {
                    this.x = currentLevel.start.x;
                    this.y = currentLevel.start.y;
                    speed.x = currentLevel.initSpeed.x;
                    speed.y = currentLevel.initSpeed.y;
                }

                this.cell.classList.add('player');
                
                /** @type {string} */
                let dir;

                if (speed.x === 0 && speed.y < 0) dir = 'dir-up';
                else if (speed.x === 0 && speed.y > 0) dir = 'dir-down';
                else if (speed.x < 0 && speed.y === 0) dir = 'dir-left';
                else if (speed.x > 0 && speed.y === 0) dir = 'dir-right';
                else if (speed.x < 0 && speed.y < 0) dir = 'dir-nw';
                else if (speed.x > 0 && speed.y < 0) dir = 'dir-ne';
                else if (speed.x < 0 && speed.y > 0) dir = 'dir-sw';
                else if (speed.x > 0 && speed.y > 0) dir = 'dir-se';

                if (dir) this.cell.classList.add(dir);
                if (!this.cell.textContent && playerSymbol.value) {
                    this.cell.textContent = playerSymbol.value;
                }
            },
            remove() {
                if (!this.cell) return;

                this.cell.classList.remove(
                    'player', 'dir-up', 'dir-down', 'dir-left', 'dir-right',
                    'dir-nw', 'dir-ne', 'dir-sw', 'dir-se'
                );
                if (this.cell.textContent === playerSymbol.value) {
                    this.cell.textContent = '';
                }
            },
            /**
             * @param {number} steps
            */
            advance(steps) {
                this.remove();
                for (let i = 0; i < steps; i++) {
                    this.x = ringClamp(0, this.x + speed.x, currentLevel.gridSize.x - 1);
                    this.y = ringClamp(0, this.y + speed.y, currentLevel.gridSize.y - 1);
                }
                this.create(false);
            },
            processMovement() {
                if (game.style.display === 'none'
                    || document.hidden
                    || !this.cell // Should not be true but still
                ) {
                    return
                };
                
                // Wall collision
                if (this.cell.classList.contains('wall')) {
                    grid.style.animation = 'lose 0.6s ease';
                    playSound('triangle', [40, 900, 40, 500], 0.5);
                    stopGameProcess();
                    this.remove();
                    launchButton.disabled = true;
                    setTimeout(() => {
                        launchButton.disabled = false;
                        this.create(true);
                    }, 1000);
                    return;
                }

                // Finish reached
                if (this.cell.classList.contains('finish')) {
                    if (!isInEditor) {
                        statsBlocks.textContent = blocksUsed;
                        statsSteps.textContent = steps;
                        stats.style.display = 'flex';
                        stats.focus();
                    }
                    grid.style.animation = 'win 1s ease';
                    playSound('sine', [40, 1000], 0.5);
                    stopGameProcess();
                    this.remove();
                    launchButton.disabled = true;
                    setTimeout(() => {
                        launchButton.disabled = false;
                        this.create(true);
                    }, 1000);
                    return;
                }

                // Switch direction
                switch (this.cell.classList.item(1)) {
                    case 'turn-up':
                        speed.x = 0;
                        speed.y = -1;
                        this.advance(1);
                        playSound('sine', [40, 250], 0.2);
                        break;
                    case 'turn-down':
                        speed.x = 0;
                        speed.y = 1;
                        this.advance(1);
                        playSound('sine', [40, 250], 0.2);
                        break;
                    case 'turn-left':
                        speed.x = -1;
                        speed.y = 0;
                        this.advance(1);
                        playSound('sine', [40, 250], 0.2);
                        break;
                    case 'turn-right':
                        speed.x = 1;
                        speed.y = 0;
                        this.advance(1);
                        playSound('sine', [40, 250], 0.2);
                        break;
                    case 'turn-nw':
                        speed.x = -1;
                        speed.y = -1;
                        this.advance(1);
                        playSound('sine', [40, 250], 0.2);
                        break;
                    case 'turn-ne':
                        speed.x = 1;
                        speed.y = -1;
                        this.advance(1);
                        playSound('sine', [40, 250], 0.2);
                        break;
                    case 'turn-sw':
                        speed.x = -1;
                        speed.y = 1;
                        this.advance(1);
                        playSound('sine', [40, 250], 0.2);
                        break;
                    case 'turn-se':
                        speed.x = 1;
                        speed.y = 1;
                        this.advance(1);
                        playSound('sine', [40, 250], 0.2);
                        break;
                    case 'jump':
                        playSound('triangle', [80, 40, 150], 0.2);
                        this.advance(2);
                        break;
                    case 'teleport':
                        this.remove();
                        this.x = currentLevel.start.x;
                        this.y = currentLevel.start.y;
                        this.create(false);
                        playSound('sine', [40, 500], 0.2);
                        break;
                    default:
                        this.advance(1);
                        playSound('sine', [40, 90], 0.2);
                        break;
                }

                steps ++;
            }
        };

        let currentLevel = new Level(
            { x: 5, y: 5}, { x: 2, y: 2 }, { x: 0, y: 1 }, []
        );

        // Standard levels
        /** @type {Level[][]} */
        let standardLevels = [
            [ // Episode 1. Theory
                new Level( // E1M1
                    { x: 5, y: 5 },
                    { x: 2, y: 0 },
                    { x: 0, y: 1 },
                    [
                        { x: 2, y: 4, type: 'finish' }
                    ]
                ),
                new Level( // E1M2
                    { x: 5, y: 5 },
                    { x: 2, y: 3 },
                    { x: 0, y: 1 },
                    [
                        { x: 2, y: 2, type: 'finish' }
                    ]
                ),
                new Level( // E1M3
                    { x: 5, y: 5 },
                    { x: 0, y: 0 },
                    { x: 0, y: 1 },
                    [
                        { x: 0, y: 4, type: 'turn-right' },
                        { x: 4, y: 4, type: 'finish' }
                    ]
                ),
                new Level( // E1M4
                    { x: 5, y: 5 },
                    { x: 0, y: 0 },
                    { x: 0, y: 1 },
                    [
                        { x: 4, y: 0, type: 'finish' },
                        { x: 0, y: 4, type: 'turn-right' },
                        { x: 4, y: 4, type: 'teleport' }
                    ]
                ),
                new Level( // E1M5
                    { x: 5, y: 5 },
                    { x: 0, y: 0 },
                    { x: 1, y: 1 },
                    [
                        { x: 4, y: 0, type: 'finish' },
                        { x: 0, y: 4, type: 'turn-ne' },
                        { x: 4, y: 4, type: 'turn-left' }
                    ]
                )
            ],
            [ // Episode 2. Practice
                new Level( // E2M1
                    { x: 5, y: 5 },
                    { x: 0, y: 4 },
                    { x: 0, y: -1 },
                    [
                        { x: 1, y: 1, type: 'wall' },
                        { x: 1, y: 2, type: 'wall' },
                        { x: 2, y: 2, type: 'finish' },
                        { x: 1, y: 3, type: 'wall' }
                    ]
                ),
                new Level( // E2M2
                    { x: 5, y: 5 },
                    { x: 0, y: 1 },
                    { x: -1, y: 1 },
                    [
                        { x: 1, y: 0, type: 'wall' },
                        { x: 2, y: 0, type: 'wall' },
                        { x: 3, y: 0, type: 'wall' },
                        { x: 1, y: 1, type: 'wall' },
                        { x: 2, y: 1, type: 'finish' },
                        { x: 3, y: 1, type: 'wall' },
                        { x: 2, y: 2, type: 'wall' }
                    ]
                ),
                new Level( // E2M3
                    { x: 6, y: 5 },
                    { x: 2, y: 3 },
                    { x: -1, y: 0 },
                    [
                        { x: 2, y: 0, type: 'wall' },
                        { x: 3, y: 0, type: 'wall' },
                        { x: 0, y: 1, type: 'wall' },
                        { x: 2, y: 1, type: 'wall' },
                        { x: 3, y: 1, type: 'finish' },
                        { x: 0, y: 2, type: 'wall' },
                        { x: 2, y: 2, type: 'wall' },
                        { x: 3, y: 2, type: 'wall' },
                        { x: 5, y: 2, type: 'wall' },
                        { x: 3, y: 3, type: 'wall' },
                        { x: 5, y: 3, type: 'wall' },
                        { x: 2, y: 4, type: 'wall' },
                        { x: 3, y: 4, type: 'wall' }
                    ]
                )
            ],
            [ // Episode 3. Creativity
                new Level( // E3M1
                    { x: 10, y: 7 },
                    { x: 9, y: 2 },
                    { x: -1, y: 0 },
                    [
                        { x: 0, y: 0, type: 'wall' },
                        { x: 1, y: 0, type: 'wall' },
                        { x: 2, y: 0, type: 'wall' },
                        { x: 0, y: 1, type: 'finish' },
                        { x: 2, y: 1, type: 'wall' },
                        { x: 4, y: 1, type: 'wall' },
                        { x: 5, y: 1, type: 'wall' },
                        { x: 6, y: 1, type: 'wall' },
                        { x: 7, y: 1, type: 'wall' },
                        { x: 8, y: 1, type: 'wall' },
                        { x: 9, y: 1, type: 'wall' },
                        { x: 0, y: 2, type: 'wall' },
                        { x: 2, y: 2, type: 'wall' },
                        { x: 4, y: 2, type: 'wall' },
                        { x: 0, y: 3, type: 'wall' },
                        { x: 2, y: 3, type: 'wall' },
                        { x: 4, y: 3, type: 'wall' },
                        { x: 6, y: 3, type: 'wall' },
                        { x: 7, y: 3, type: 'wall' },
                        { x: 8, y: 3, type: 'wall' },
                        { x: 9, y: 3, type: 'wall' },
                        { x: 0, y: 4, type: 'wall' },
                        { x: 2, y: 4, type: 'wall' },
                        { x: 3, y: 4, type: 'wall' },
                        { x: 4, y: 4, type: 'wall' },
                        { x: 6, y: 4, type: 'wall' },
                        { x: 0, y: 5, type: 'wall' },
                        { x: 6, y: 5, type: 'wall' },
                        { x: 0, y: 6, type: 'wall' },
                        { x: 1, y: 6, type: 'wall' },
                        { x: 2, y: 6, type: 'wall' },
                        { x: 3, y: 6, type: 'wall' },
                        { x: 4, y: 6, type: 'wall' },
                        { x: 5, y: 6, type: 'wall' },
                        { x: 6, y: 6, type: 'wall' }
                    ]
                ),
                new Level( // E3M2
                    { x: 7, y: 14 },
                    { x: 3, y: 12 },
                    { x: 0, y: -1 },
                    [
                        { x: 3, y: 0, type: 'wall' },
                        { x: 1, y: 1, type: 'wall' },
                        { x: 2, y: 1, type: 'wall' },
                        { x: 4, y: 1, type: 'wall' },
                        { x: 5, y: 1, type: 'wall' },
                        { x: 1, y: 2, type: 'wall' },
                        { x: 2, y: 2, type: 'finish' },
                        { x: 3, y: 2, type: 'wall' },
                        { x: 4, y: 2, type: 'finish' },
                        { x: 5, y: 2, type: 'wall' },
                        { x: 2, y: 3, type: 'wall' },
                        { x: 4, y: 3, type: 'wall' },
                        { x: 3, y: 4, type: 'wall' },
                        { x: 1, y: 5, type: 'wall' },
                        { x: 2, y: 5, type: 'wall' },
                        { x: 4, y: 5, type: 'wall' },
                        { x: 5, y: 5, type: 'wall' },
                        { x: 0, y: 6, type: 'wall' },
                        { x: 2, y: 6, type: 'wall' },
                        { x: 3, y: 6, type: 'wall' },
                        { x: 4, y: 6, type: 'wall' },
                        { x: 6, y: 6, type: 'wall' },
                        { x: 0, y: 7, type: 'wall' },
                        { x: 2, y: 7, type: 'wall' },
                        { x: 3, y: 7, type: 'jump' },
                        { x: 4, y: 7, type: 'wall' },
                        { x: 6, y: 7, type: 'wall' },
                        { x: 0, y: 8, type: 'jump' },
                        { x: 2, y: 8, type: 'wall' },
                        { x: 3, y: 8, type: 'wall' },
                        { x: 4, y: 8, type: 'wall' },
                        { x: 6, y: 8, type: 'jump' },
                        { x: 2, y: 9, type: 'wall' },
                        { x: 4, y: 9, type: 'wall' },
                        { x: 1, y: 10, type: 'wall' },
                        { x: 5, y: 10, type: 'wall' },
                        { x: 1, y: 11, type: 'wall' },
                        { x: 5, y: 11, type: 'wall' },
                        { x: 1, y: 12, type: 'wall' },
                        { x: 5, y: 12, type: 'wall' },
                        { x: 0, y: 13, type: 'wall' },
                        { x: 1, y: 13, type: 'wall' },
                        { x: 2, y: 13, type: 'wall' },
                        { x: 4, y: 13, type: 'wall' },
                        { x: 5, y: 13, type: 'wall' },
                        { x: 6, y: 13, type: 'wall' }
                    ]
                )
            ]
        ];

        // Variables
        /** @type {boolean} */
        let isInEditor = false;
        /** @type {number} */
        let moveInterval = null;
        /** @type {string} */
        let lastCellType = null;
        /** @type {{x: number, y: number}} */
        let selected = { x: 0, y: 0 };
        /** @type {{x: number, y: number}} */
        let speed = { x: 0, y: 0 };
        /** @type {number} */
        let blocksUsed = 0;
        /** @type {number} */
        let steps = 0;
        /** @type {number} */
        let currentEpisode = 0;
        /** @type {number} */
        let currentMap = 0;
        /** @type {AudioContext} */
        let audio = new (window.AudioContext || window.webkitAudioContext)();

        // Resetting some elements & loading settings
        loadSettings();
        vectorMenu.value = 'dir-down';
        copyLast.checked = false;

        // Settings' events
        playerSymbol.addEventListener('input', function (event) {
            localStorage.setItem('playerSymbol', playerSymbol.value);
            settingsPlayer.textContent = playerSymbol.value;
        });
        playerColour.addEventListener('input', function (event) {
            localStorage.setItem('playerColour', playerColour.value);
            document.body.style.setProperty('--player', playerColour.value);
        });
        playerBorderColour.addEventListener('input', function (event) {
            localStorage.setItem('playerBorderColour', playerBorderColour.value);
            document.body.style.setProperty('--player-border', playerBorderColour.value);
        });
        gameSpeed.addEventListener('click', function (event) {
            gameSpeed.focus();
        });
        gameSpeed.addEventListener('blur', function (event) {
            gameSpeed.value = clamp(+gameSpeed.min, +gameSpeed.value, +gameSpeed.max);
            localStorage.setItem('gameSpeed', +gameSpeed.value);

            if (moveInterval) {
                stopGameProcess();
                moveInterval = setInterval(function () {
                    player.processMovement();
                }, +gameSpeed.value);
            }
        });
        gameVolume.addEventListener('change', function (event) {
            gameVolume.value = clamp(0, +gameVolume.value, 1);
            localStorage.setItem('gameVolume', gameVolume.value);
        });
        defaultSettings.addEventListener('click', function (event) {
            playerSymbol.value = '';
            playerColour.value = '#ff4343';
            playerBorderColour.value = '#590000';
            gameSpeed.value = '500';
            gameVolume.value = '0.5';

            localStorage.setItem('playerSymbol', playerSymbol.value);
            localStorage.setItem('playerColour', playerColour.value);
            localStorage.setItem('playerBorderColour', playerBorderColour.value);
            localStorage.setItem('gameSpeed', gameSpeed.value);
            localStorage.setItem('gameVolume', gameVolume.value);

            settingsPlayer.textContent = playerSymbol.value;
            document.body.style.setProperty('--player', playerColour.value);
            document.body.style.setProperty('--player-border', playerBorderColour.value);
        });

        // Exiting on pressing Escape
        levels.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') switchScene('levels', 'menu');
        });
        blocks.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') switchScene('blocks', 'game');
        });
        game.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') switchScene('game', isInEditor ? 'menu' : 'levels');
        });
        settings.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') switchScene('settings', 'menu');
        });
        about.addEventListener('keydown', function (event) {
            if (event.key === 'Escape') switchScene('about', 'menu');
        });

        // Other events
        continueButton.addEventListener('click', function (event) {
            if (grid.hasChildNodes()) {
                startGame("levels", false);
            } else {
                loadStandardLevel(
                    document.getElementById(
                        `e${currentEpisode + 1}m${currentMap + 1}`
                    ),
                    currentEpisode, currentMap
                );
            }
        });

        launchButton.addEventListener('click', function (event) {
            steps = 0;
            player.remove();
            player.create(true);
            stats.style.display = 'none';

            if (moveInterval === null) {
                moveInterval = setInterval(function () {
                    player.processMovement();
                }, +gameSpeed.value);
                grid.style.animation = 'none';
            }
        });

        stopButton.addEventListener('click', function (event) {
            stopGameProcess();
            player.remove();
            player.create(true);
        });

        resetButton.addEventListener('click', function (event) {
            stopGameProcess();
            fillGrid();
        });

        saveLevelButton.addEventListener('click', function (event) {
            if (!grid.hasChildNodes()) return;

            // Iterate over cells and save those with special classes
            saveGridBlocks();

            let data = encodeURIComponent(
                JSON.stringify(currentLevel, null, 2)
            );
            saveLevelButton.download = 'MyLevel.json';
            saveLevelButton.href = `data:text/plain;charset=utf-8,${data}`;
            console.log(`new Level(\n\t{ x: ${currentLevel.gridSize.x}, y: ${currentLevel.gridSize.y} },\n\t{ x: ${currentLevel.start.x}, y: ${currentLevel.start.y} },\n\t{ x: ${currentLevel.initSpeed.x}, y: ${currentLevel.initSpeed.y} },\n\t[${currentLevel.blocks.map(
                b => {return `\n\t\t{ x: ${b.x}, y: ${b.y}, type: '${b.type}' }`}
            )}\n\t]\n)`);
        });

        loadLevel.addEventListener('input', function (event) {
            loadLevelFromFile(event, loadLevel);
        });

        editorLoadLevel.addEventListener('input', function (event) {
            loadLevelFromFile(event, editorLoadLevel);
        });

        sizeX.addEventListener('click', function (event) {
            sizeX.focus();
        });

        sizeY.addEventListener('click', function (event) {
            sizeY.focus();
        });

        sizeX.addEventListener('blur', function (event) {
            currentLevel.gridSize.x = clamp(+sizeX.min, +sizeX.value, +sizeX.max);
            saveGridBlocks();
            fillGrid();
        });

        sizeY.addEventListener('blur', function (event) {
            currentLevel.gridSize.y = clamp(+sizeY.min, +sizeY.value, +sizeY.max);
            saveGridBlocks();
            fillGrid();
        });

        vectorMenu.addEventListener('change', function (event) {
            player.remove();
            
            switch (vectorMenu.value) {
                case 'dir-up':
                    currentLevel.initSpeed.x = 0;
                    currentLevel.initSpeed.y = -1;
                    break;
                case 'dir-down':
                    currentLevel.initSpeed.x = 0;
                    currentLevel.initSpeed.y = 1;
                    break;
                case 'dir-right':
                    currentLevel.initSpeed.x = 1;
                    currentLevel.initSpeed.y = 0;
                    break;
                case 'dir-left':
                    currentLevel.initSpeed.x = -1;
                    currentLevel.initSpeed.y = 0;
                    break;
                case 'dir-ne':
                    currentLevel.initSpeed.x = 1;
                    currentLevel.initSpeed.y = -1;
                    break;
                case 'dir-se':
                    currentLevel.initSpeed.x = 1;
                    currentLevel.initSpeed.y = 1;
                    break;
                case 'dir-sw':
                    currentLevel.initSpeed.x = -1;
                    currentLevel.initSpeed.y = 1;
                    break;
                case 'dir-nw':
                    currentLevel.initSpeed.x = -1;
                    currentLevel.initSpeed.y = -1;
                    break;
                default:
                    break;
            }

            player.create(true);
        });

        // Functions
        function loadSettings() {
            currentEpisode = +localStorage.getItem('episode') || 0;
            currentMap = +localStorage.getItem('map') || 0;
            playerSymbol.value = localStorage.getItem('playerSymbol') || '';
            playerColour.value = localStorage.getItem('playerColour') || '#ff4343';
            playerBorderColour.value = localStorage.getItem('playerBorderColour') || '#590000';
            gameSpeed.value = clamp(
                +gameSpeed.min,
                +localStorage.getItem('gameSpeed') || 500,
                +gameSpeed.max
            );
            gameVolume.value = clamp(
                0,
                +localStorage.getItem('gameVolume') || 0.5,
                1
            );

            settingsPlayer.textContent = playerSymbol.value;
            document.body.style.setProperty('--player', playerColour.value);
            document.body.style.setProperty('--player-border', playerBorderColour.value);
        }

        /**
         * @param {InputEvent} event
         * @param {HTMLInputElement} input
        */
        async function loadLevelFromFile(event, input) {
            await input.files[0].text().then((data) => {
                try {
                    currentLevel = JSON.parse(data);
                    fillGrid();
                } catch (error) {
                    alert(`Error while loading the level: ${error}`);
                    currentLevel = {
                        gridSize: { x: 5, y: 5},
                        start: { x: 2, y: 2},
                        initSpeed: { x: 0, y: 1 },
                        blocks: []
                    };
                    fillGrid();
                } finally {
                    levelTitle.textContent = input.files[0].name.replace('.json', '');
                    stats.style.display = 'none';
                    if (input === loadLevel) {
                        startGame('levels', false);
                    }
                    player.cell?.focus();
                    input.value = '';
                }
            });
        }

        /**
         * @param {HTMLButtonElement} button
         * @param {number} episode
         * @param {number} map
        */
        function loadStandardLevel(button, episode, map) {
            /** @type {Level} */
            let sl = standardLevels[episode][map];
            if (!sl) return;

            localStorage.setItem('episode', episode);
            localStorage.setItem('map', map);
            currentEpisode = episode;
            currentMap = map;
            currentLevel = new Level(sl.gridSize, sl.start, sl.initSpeed, sl.blocks);
            levelTitle.textContent = button.textContent || '';
            stats.style.display = 'none';
            fillGrid();
            startGame('levels', false);
            player.cell?.focus();
        }

        function nextStandardLevel() {
            currentMap ++;
            
            if (!standardLevels[currentEpisode][currentMap]) {
                currentEpisode ++;
                currentMap = 0;

                if (!standardLevels[currentEpisode]) {
                    currentEpisode = 1;
                }
            }

            /** @type {HTMLButtonElement} */
            let button = document.getElementById(
                `e${currentEpisode + 1}m${currentMap + 1}`
            );
            
            loadStandardLevel(button, currentEpisode, currentMap);
        }

        function fillGrid() {
            // Reset everything
            player.remove();
            stopGameProcess();
            continueButton.disabled = false;
            while (grid.hasChildNodes()) grid.lastChild.remove();

            // Set X and Y dimenstions in the editor
            sizeX.value = currentLevel.gridSize.x;
            sizeY.value = currentLevel.gridSize.y;

            // Create rows and cells
            for (let y = 0; y < currentLevel.gridSize.y; y++) {
                /** @type {HTMLDivElement} */
                let row = grid.appendChild(
                    document.createElement('div')
                );
                row.classList.add('row');

                for (let x = 0; x < currentLevel.gridSize.x; x++) {
                    /** @type {HTMLDivElement} */
                    let cell = row.appendChild(
                        document.createElement('div')
                    );
                    cell.classList.add('cell');
                    cell.tabIndex = 0;
                    cell.id = `${x};${y}`;
                    cell.addEventListener('keydown', function (event) {
                        switch (event.key) {
                            case 'ArrowUp':
                                event.preventDefault();
                                getCell(
                                    x,
                                    ringClamp(0, y - 1, currentLevel.gridSize.y - 1)
                                )?.focus();
                                break;
                            case 'ArrowDown':
                                event.preventDefault();
                                getCell(
                                    x,
                                    ringClamp(0, y + 1, currentLevel.gridSize.y - 1)
                                )?.focus();
                                break;
                            case 'ArrowLeft':
                                event.preventDefault();
                                getCell(
                                    ringClamp(0, x - 1, currentLevel.gridSize.x - 1),
                                    y
                                )?.focus();
                                break;
                            case 'ArrowRight':
                                event.preventDefault();
                                getCell(
                                    ringClamp(0, x + 1, currentLevel.gridSize.x - 1),
                                    y
                                )?.focus();
                                break;
                            case 'Enter':
                            case ' ':
                                event.preventDefault();
                                if (isCellEditable(x, y)) {
                                    if (isInEditor
                                        && copyLast.checked
                                        && lastCellType
                                        && !cell.classList.contains(lastCellType)
                                    ) {
                                        setCell(x, y, lastCellType);
                                    } else {
                                        switchScene('game', 'blocks');
                                        selected.x = x;
                                        selected.y = y;
                                    }
                                }
                                break;
                            default:
                                break;
                        }
                    });
                    cell.addEventListener('mousedown', function (event) {
                        event.preventDefault();
                        if (event.button === 2) { // Right mouse key
                            cell.blur();
                            setCell(x, y, 'cell');
                            cell.focus();
                        } else if (isCellEditable(x, y)) {
                            if (isInEditor
                                && copyLast.checked 
                                && lastCellType
                                && !cell.classList.contains(lastCellType)
                            ) {
                                setCell(x, y, lastCellType);
                                cell.focus();
                            } else {
                                switchScene('game', 'blocks');
                                selected.x = x;
                                selected.y = y;
                            }
                        }
                    });
                    cell.addEventListener('mouseenter', function (event) {
                        if (event.shiftKey && lastCellType) {
                            setCell(x, y, lastCellType);
                        }
                    });
                    cell.addEventListener('contextmenu', function (event) {
                        event.preventDefault();
                        cell.blur();
                        setCell(x, y, 'cell');
                        cell.focus();
                    });
                }
            }

            // Add player
            player.create(true);

            // Fill special cells
            if (currentLevel.blocks) {
                for (let b of currentLevel.blocks) {
                    setCell(b.x, b.y, b.type);
                    getCell(b.x, b.y)?.classList.add('protected');
                }
            }

            // Reset blocks counter
            blocksUsed = 0;
        }

        /**
         * @param {string} dir
        */
        function shiftAll(dir) {
            saveGridBlocks();
            player.remove();

            /** @type {number} */
            let x = dir === 'E' ? 1 : dir === 'W' ? -1 : 0;
            /** @type {number} */
            let y = dir === 'S' ? 1 : dir === 'N' ? -1 : 0;

            currentLevel.start.x = ringClamp(0, currentLevel.start.x + x, currentLevel.gridSize.x - 1);
            currentLevel.start.y = ringClamp(0, currentLevel.start.y + y, currentLevel.gridSize.y - 1);

            for (let block of currentLevel.blocks) {
                block.x = ringClamp(0, block.x + x, currentLevel.gridSize.x - 1);
                block.y = ringClamp(0, block.y + y, currentLevel.gridSize.y - 1);
            }

            fillGrid();
        }

        function saveGridBlocks() {
            currentLevel.blocks = [];

            for (let y = 0; y < currentLevel.gridSize.y; y++) {
                for (let x = 0; x < currentLevel.gridSize.x; x++) {
                    /** @type {HTMLDivElement} */
                    let cell = getCell(x, y);

                    if (cell
                        && cell.classList.length > 1
                        && cell.classList.item(1) !== 'player'
                    ) {
                        currentLevel.blocks.push({
                            x: x,
                            y: y,
                            type: cell.classList.item(1)
                        });
                    }
                }
            }
        }

        /**
         * @param {number} x
         * @param {number} y
         * @param {string} type
        */
        function setCell(x, y, type) {
            /** @type {HTMLDivElement} */
            let cell = getCell(x, y);
            if (!cell || !isCellEditable(x, y)) return;

            // Manage the number of used blocks
            if (!isInEditor) {
                if (type !== 'cell') {
                    // Adding a block to an empty (!) cell
                    if (cell.className === 'cell') {
                        blocksUsed ++;
                    }
                } else {
                    // Deleting a block (must not be empty!)
                    if (cell.className !== 'cell') {
                        blocksUsed --;
                    }
                }
            }

            // Resetting types
            cell.className = '';
            cell.classList.add('cell');

            // Adding the type
            switch (type) {
                case 'cell':
                    cell.textContent = '';
                    break;
                case 'player':
                    currentLevel.start.x = x;
                    currentLevel.start.y = y;
                    player.remove();
                    player.create(true);
                    break; // Never forget `break;` like I did!
                default:
                    cell.classList.add(type);
                    if (isInEditor) cell.classList.add('protected');
                    break;
            }
            
            // Update last cell type
            if (type !== 'player'
                && type !== 'finish'
                && type !== 'cell'
            ) {
                lastCellType = type;
            } else {
                lastCellType = null;
            }
        }

        /**
         * @param {number} x
         * @param {number} y
         * @param {string} type
        */
        function setCellAndReturn(x, y, type) {
            setCell(x, y, type);
            switchScene('blocks', 'game');
            getCell(x, y)?.focus();
        }

        /**
         * @param {number} x
         * @param {number} y
         * @returns {HTMLDivElement}
        */
        function getCell(x, y) {
            /** @type {HTMLDivElement} */
            let cell = document.getElementById(`${x};${y}`);
            return cell;
        }

        /**
         * @param {number} x
         * @param {number} y
         * @returns {boolean}
        */
        function isCellEditable(x, y) {
            /** @type {HTMLDivElement} */
            let cell = getCell(x, y);
            if (!cell) return false;
            return (
                isInEditor
                || (!cell.classList.contains('protected')
                    && !cell.classList.contains('player')
                    && !cell.classList.contains('finish'))
            );
        }

        function stopGameProcess() {
            if (moveInterval) {
                clearInterval(moveInterval);
                moveInterval = null;
            }
        }

        /**
         * @param {string} from
         * @param {boolean} editorMode
        */
        function startGame(from, editorMode) {
            lastCellType = null;
            isInEditor = editorMode;
            
            if (isInEditor === true) fillGrid();
            if (!moveInterval) player.create(true);

            for (let e of document.getElementsByClassName('editor-only')) {
                e.style.display = editorMode ? 'flex' : 'none';
            }
            switchScene(from, 'game');
        }

        function pauseGame() {
            if (isInEditor) saveGridBlocks();
            switchScene('game', isInEditor ? 'menu' : 'levels');
        }

        function switchScene(from, to) {
            if (from === to) return;
            if (from === 'game') grid.style.animation = 'none';

            try {
                document.getElementById(from).style.display = 'none';
                document.getElementById(to).style.display = 'flex';
                document.getElementById(to).focus();
            } catch (error) {
                console.log(error);
            }

            if (to === 'game') {
                getCell(selected.x, selected.y)?.focus();
            }
        }

        /**
         * @param {'square' | 'sawtooth' | 'triangle' | 'sine'} type
         * @param {number[]} frequencies
         * @param {number} duration
        */
        function playSound(type, frequencies, duration) {
            if (!audio || +gameVolume.value === 0) return;

            /** @type {OscillatorNode} */
            let oscillator = audio.createOscillator();
            /** @type {GainNode} */
            let volume = audio.createGain();
            
            oscillator.type = type;
            oscillator.frequency.value = frequencies[0];
            oscillator.frequency.setValueCurveAtTime(
                frequencies,
                audio.currentTime,
                duration
            );
            oscillator.connect(volume);
            
            volume.gain.value = +gameVolume.value;
            volume.gain.setValueCurveAtTime(
                [0, +gameVolume.value, 0],
                audio.currentTime,
                duration
            );
            volume.connect(audio.destination);

            oscillator.start();
            oscillator.stop(audio.currentTime + duration);
        }

        /**
         * @param {number} min
         * @param {number} value
         * @param {number} max
         * @returns {number}
        */
        function ringClamp(min, value, max) {
            return value < min
                ? max
                : value > max
                    ? min
                    : value;
        }

        /**
         * @param {number} min
         * @param {number} value
         * @param {number} max
         * @returns {number}
        */
        function clamp(min, value, max) {
            return value < min
                ? min
                : value > max
                    ? max
                    : value;
        }

        generateLanguagesList([
            {
                name: 'English [Vitaly Ulyanov]',
                langTags: ['en', 'en-AU', 'en-BZ', 'en-CA', 'en-CB', 'en-GB', 'en-IE', 'en-JM', 'en-NZ', 'en-PH', 'en-TT', 'en-US', 'en-ZA', 'en-ZW'],
                elements: [
                    {
                        "id": "exportLang",
                        "childNodesTexts": [
                            "Export texts for translation"
                        ]
                    },
                    {
                        "id": "title",
                        "childNodesTexts": [
                            "Route"
                        ]
                    },
                    {
                        "id": "start-button",
                        "childNodesTexts": [
                            "Play"
                        ]
                    },
                    {
                        "id": "editor-button",
                        "childNodesTexts": [
                            "Level editor"
                        ]
                    },
                    {
                        "id": "settings-button",
                        "childNodesTexts": [
                            "Settings"
                        ]
                    },
                    {
                        "id": "about-button",
                        "childNodesTexts": [
                            "About"
                        ]
                    },
                    {
                        "id": "author",
                        "childNodesTexts": [
                            "Made by ",
                            "Vitaly Pavlovich Ulyanov (Vital)",
                            "."
                        ]
                    },
                    {
                        "id": "levels-title",
                        "childNodesTexts": [
                            "Levels"
                        ]
                    },
                    {
                        "id": "levels-back",
                        "childNodesTexts": [
                            "Back"
                        ]
                    },
                    {
                        "id": "continue",
                        "childNodesTexts": [
                            "Continue"
                        ]
                    },
                    {
                        "id": "nextLevelFromMenu",
                        "childNodesTexts": [
                            "Next level"
                        ]
                    },
                    {
                        "id": "load-label",
                        "childNodesTexts": [
                            "Load level"
                        ]
                    },
                    {
                        "id": "e1",
                        "childNodesTexts": [
                            "1. Theory"
                        ]
                    },
                    {
                        "id": "e1m1",
                        "childNodesTexts": [
                            "1.1. Your goal is here"
                        ]
                    },
                    {
                        "id": "e1m2",
                        "childNodesTexts": [
                            "1.2. Over the edge"
                        ]
                    },
                    {
                        "id": "e1m3",
                        "childNodesTexts": [
                            "1.3. New turn"
                        ]
                    },
                    {
                        "id": "e1m4",
                        "childNodesTexts": [
                            "1.4. Teleportation"
                        ]
                    },
                    {
                        "id": "e1m5",
                        "childNodesTexts": [
                            "1.5. Diagonal"
                        ]
                    },
                    {
                        "id": "e2",
                        "childNodesTexts": [
                            "2. Practice"
                        ]
                    },
                    {
                        "id": "e2m1",
                        "childNodesTexts": [
                            "2.1. Tiny wall"
                        ]
                    },
                    {
                        "id": "e2m2",
                        "childNodesTexts": [
                            "2.2. Breach"
                        ]
                    },
                    {
                        "id": "e2m3",
                        "childNodesTexts": [
                            "2.3. Neighbours"
                        ]
                    },
                    {
                        "id": "e3",
                        "childNodesTexts": [
                            "3. Creativity"
                        ]
                    },
                    {
                        "id": "e3m1",
                        "childNodesTexts": [
                            "3.1. Pipes"
                        ]
                    },
                    {
                        "id": "e3m2",
                        "childNodesTexts": [
                            "3.2. Robot"
                        ]
                    },
                    {
                        "id": "game-back",
                        "childNodesTexts": [
                            "Back"
                        ]
                    },
                    {
                        "id": "nextLevelFromStats",
                        "childNodesTexts": [
                            "Next level"
                        ]
                    },
                    {
                        "id": "stats-label",
                        "childNodesTexts": [
                            "Victory!"
                        ]
                    },
                    {
                        "id": "stats-steps-label",
                        "childNodesTexts": [
                            "Steps taken"
                        ]
                    },
                    {
                        "id": "stats-blocks-label",
                        "childNodesTexts": [
                            "Blocks used"
                        ]
                    },
                    {
                        "id": "editor-load-label",
                        "childNodesTexts": [
                            "Load level"
                        ]
                    },
                    {
                        "id": "save-level-button",
                        "childNodesTexts": [
                            "Save level"
                        ]
                    },
                    {
                        "id": "editor-tools-summary",
                        "childNodesTexts": [
                            "Level settings"
                        ]
                    },
                    {
                        "id": "grid-size-label",
                        "childNodesTexts": [
                            "Grid size:"
                        ]
                    },
                    {
                        "id": "vector-label",
                        "childNodesTexts": [
                            "Player's vector:"
                        ]
                    },
                    {
                        "id": "vector-menu",
                        "childNodesTexts": [
                            "North (N)",
                            "South (S)",
                            "East (E)",
                            "West (W)",
                            "Northeast (NE)",
                            "Southeast (SE)",
                            "Southwest (SW)",
                            "Northwest (NW)"
                        ]
                    },
                    {
                        "id": "shift-all",
                        "childNodesTexts": [
                            "Shift blocks"
                        ]
                    },
                    {
                        "id": "shift-n",
                        "childNodesTexts": [
                            "N"
                        ]
                    },
                    {
                        "id": "shift-s",
                        "childNodesTexts": [
                            "S"
                        ]
                    },
                    {
                        "id": "shift-e",
                        "childNodesTexts": [
                            "E"
                        ]
                    },
                    {
                        "id": "shift-w",
                        "childNodesTexts": [
                            "W"
                        ]
                    },
                    {
                        "id": "copy-last-label",
                        "childNodesTexts": [
                            "Copy last block on click"
                        ]
                    },
                    {
                        "id": "launch",
                        "childNodesTexts": [
                            "Start"
                        ]
                    },
                    {
                        "id": "stop",
                        "childNodesTexts": [
                            "Stop"
                        ]
                    },
                    {
                        "id": "reset",
                        "childNodesTexts": [
                            "Reset"
                        ]
                    },
                    {
                        "id": "blocks-title",
                        "childNodesTexts": [
                            "Blocks"
                        ]
                    },
                    {
                        "id": "blocks-back",
                        "childNodesTexts": [
                            "Return to game"
                        ]
                    },
                    {
                        "id": "blocks-player",
                        "childNodesTexts": [
                            "Player"
                        ]
                    },
                    {
                        "id": "blocks-finish",
                        "childNodesTexts": [
                            "Finish"
                        ]
                    },
                    {
                        "id": "blocks-empty",
                        "childNodesTexts": [
                            "Empty"
                        ]
                    },
                    {
                        "id": "blocks-wall",
                        "childNodesTexts": [
                            "Wall"
                        ]
                    },
                    {
                        "id": "blocks-jump",
                        "childNodesTexts": [
                            "Jump"
                        ]
                    },
                    {
                        "id": "blocks-teleport",
                        "childNodesTexts": [
                            "To start"
                        ]
                    },
                    {
                        "id": "blocks-n",
                        "childNodesTexts": [
                            "Turn N"
                        ]
                    },
                    {
                        "id": "blocks-s",
                        "childNodesTexts": [
                            "Turn S"
                        ]
                    },
                    {
                        "id": "blocks-e",
                        "childNodesTexts": [
                            "Turn E"
                        ]
                    },
                    {
                        "id": "blocks-w",
                        "childNodesTexts": [
                            "Turn W"
                        ]
                    },
                    {
                        "id": "blocks-ne",
                        "childNodesTexts": [
                            "Turn NE"
                        ]
                    },
                    {
                        "id": "blocks-se",
                        "childNodesTexts": [
                            "Turn SE"
                        ]
                    },
                    {
                        "id": "blocks-sw",
                        "childNodesTexts": [
                            "Turn SW"
                        ]
                    },
                    {
                        "id": "blocks-nw",
                        "childNodesTexts": [
                            "Turn NW"
                        ]
                    },
                    {
                        "id": "settings-title",
                        "childNodesTexts": [
                            "Settings"
                        ]
                    },
                    {
                        "id": "settings-back",
                        "childNodesTexts": [
                            "Back"
                        ]
                    },
                    {
                        "id": "player-symbol-label",
                        "childNodesTexts": [
                            "Player's symbol"
                        ]
                    },
                    {
                        "id": "player-colour-label",
                        "childNodesTexts": [
                            "Player's colour"
                        ]
                    },
                    {
                        "id": "player-border-colour-label",
                        "childNodesTexts": [
                            "Player's border colour"
                        ]
                    },
                    {
                        "id": "game-speed-label",
                        "childNodesTexts": [
                            "Step interval (in milliseconds)"
                        ]
                    },
                    {
                        "id": "game-volume-label",
                        "childNodesTexts": [
                            "Sound volume"
                        ]
                    },
                    {
                        "id": "default-settings",
                        "childNodesTexts": [
                            "Restore default settings"
                        ]
                    },
                    {
                        "id": "about-title",
                        "childNodesTexts": [
                            "About"
                        ]
                    },
                    {
                        "id": "about-back",
                        "childNodesTexts": [
                            "Back"
                        ]
                    }
                ]
            },
            {
                name: 'Русский [Виталий Ульянов]',
                langTags: ['ru', 'ru-RU'],
                elements: [
                    {
                        "id": "exportLang",
                        "childNodesTexts": [
                            "Экспорт текстов для перевода"
                        ]
                    },
                    {
                        "id": "title",
                        "childNodesTexts": [
                            "Маршрут"
                        ]
                    },
                    {
                        "id": "start-button",
                        "childNodesTexts": [
                            "Играть"
                        ]
                    },
                    {
                        "id": "editor-button",
                        "childNodesTexts": [
                            "Редактор уровней"
                        ]
                    },
                    {
                        "id": "settings-button",
                        "childNodesTexts": [
                            "Настройки"
                        ]
                    },
                    {
                        "id": "about-button",
                        "childNodesTexts": [
                            "Об игре"
                        ]
                    },
                    {
                        "id": "author",
                        "childNodesTexts": [
                            "Автор — ",
                            "Виталий Павлович Ульянов (Vital)",
                            "."
                        ]
                    },
                    {
                        "id": "levels-title",
                        "childNodesTexts": [
                            "Уровни"
                        ]
                    },
                    {
                        "id": "levels-back",
                        "childNodesTexts": [
                            "Назад"
                        ]
                    },
                    {
                        "id": "continue",
                        "childNodesTexts": [
                            "Продолжить"
                        ]
                    },
                    {
                        "id": "nextLevelFromMenu",
                        "childNodesTexts": [
                            "Следующий уровень"
                        ]
                    },
                    {
                        "id": "load-label",
                        "childNodesTexts": [
                            "Загрузить уровень"
                        ]
                    },
                    {
                        "id": "e1",
                        "childNodesTexts": [
                            "1. Теория"
                        ]
                    },
                    {
                        "id": "e1m1",
                        "childNodesTexts": [
                            "1.1. Твоя цель здесь"
                        ]
                    },
                    {
                        "id": "e1m2",
                        "childNodesTexts": [
                            "1.2. Через край"
                        ]
                    },
                    {
                        "id": "e1m3",
                        "childNodesTexts": [
                            "1.3. Новый поворот"
                        ]
                    },
                    {
                        "id": "e1m4",
                        "childNodesTexts": [
                            "1.4. Телепортация"
                        ]
                    },
                    {
                        "id": "e1m5",
                        "childNodesTexts": [
                            "1.5. Диагональ"
                        ]
                    },
                    {
                        "id": "e2",
                        "childNodesTexts": [
                            "2. Практика"
                        ]
                    },
                    {
                        "id": "e2m1",
                        "childNodesTexts": [
                            "2.1. Стеночка"
                        ]
                    },
                    {
                        "id": "e2m2",
                        "childNodesTexts": [
                            "2.2. Брешь"
                        ]
                    },
                    {
                        "id": "e2m3",
                        "childNodesTexts": [
                            "2.3. Соседи"
                        ]
                    },
                    {
                        "id": "e3",
                        "childNodesTexts": [
                            "3. Творчество"
                        ]
                    },
                    {
                        "id": "e3m1",
                        "childNodesTexts": [
                            "3.1. Трубы"
                        ]
                    },
                    {
                        "id": "e3m2",
                        "childNodesTexts": [
                            "3.2. Робот"
                        ]
                    },
                    {
                        "id": "game-back",
                        "childNodesTexts": [
                            "Назад"
                        ]
                    },
                    {
                        "id": "nextLevelFromStats",
                        "childNodesTexts": [
                            "Следующий уровень"
                        ]
                    },
                    {
                        "id": "stats-label",
                        "childNodesTexts": [
                            "Победа!"
                        ]
                    },
                    {
                        "id": "stats-steps-label",
                        "childNodesTexts": [
                            "Сделано шагов"
                        ]
                    },
                    {
                        "id": "stats-blocks-label",
                        "childNodesTexts": [
                            "Поставлено блоков"
                        ]
                    },
                    {
                        "id": "editor-load-label",
                        "childNodesTexts": [
                            "Загрузить уровень"
                        ]
                    },
                    {
                        "id": "save-level-button",
                        "childNodesTexts": [
                            "Сохранить уровень"
                        ]
                    },
                    {
                        "id": "editor-tools-summary",
                        "childNodesTexts": [
                            "Настройки уровня"
                        ]
                    },
                    {
                        "id": "grid-size-label",
                        "childNodesTexts": [
                            "Размер сетки:"
                        ]
                    },
                    {
                        "id": "vector-label",
                        "childNodesTexts": [
                            "Вектор игрока:"
                        ]
                    },
                    {
                        "id": "vector-menu",
                        "childNodesTexts": [
                            "Север (С)",
                            "Юг (Ю)",
                            "Восток (В)",
                            "Запад (З)",
                            "Северо-восток (СВ)",
                            "Юго-восток (ЮВ)",
                            "Юго-запад (ЮЗ)",
                            "Северо-запад (СЗ)"
                        ]
                    },
                    {
                        "id": "shift-all",
                        "childNodesTexts": [
                            "Сдвиг блоков"
                        ]
                    },
                    {
                        "id": "shift-n",
                        "childNodesTexts": [
                            "С"
                        ]
                    },
                    {
                        "id": "shift-s",
                        "childNodesTexts": [
                            "Ю"
                        ]
                    },
                    {
                        "id": "shift-e",
                        "childNodesTexts": [
                            "В"
                        ]
                    },
                    {
                        "id": "shift-w",
                        "childNodesTexts": [
                            "З"
                        ]
                    },
                    {
                        "id": "copy-last-label",
                        "childNodesTexts": [
                            "Нажатие копирует прошлый блок"
                        ]
                    },
                    {
                        "id": "launch",
                        "childNodesTexts": [
                            "Пуск"
                        ]
                    },
                    {
                        "id": "stop",
                        "childNodesTexts": [
                            "Стоп"
                        ]
                    },
                    {
                        "id": "reset",
                        "childNodesTexts": [
                            "Сброс"
                        ]
                    },
                    {
                        "id": "blocks-title",
                        "childNodesTexts": [
                            "Блоки"
                        ]
                    },
                    {
                        "id": "blocks-back",
                        "childNodesTexts": [
                            "Возврат к игре"
                        ]
                    },
                    {
                        "id": "blocks-player",
                        "childNodesTexts": [
                            "Игрок"
                        ]
                    },
                    {
                        "id": "blocks-finish",
                        "childNodesTexts": [
                            "Финиш"
                        ]
                    },
                    {
                        "id": "blocks-empty",
                        "childNodesTexts": [
                            "Пусто"
                        ]
                    },
                    {
                        "id": "blocks-wall",
                        "childNodesTexts": [
                            "Стена"
                        ]
                    },
                    {
                        "id": "blocks-jump",
                        "childNodesTexts": [
                            "Прыжок"
                        ]
                    },
                    {
                        "id": "blocks-teleport",
                        "childNodesTexts": [
                            "На старт"
                        ]
                    },
                    {
                        "id": "blocks-n",
                        "childNodesTexts": [
                            "На С"
                        ]
                    },
                    {
                        "id": "blocks-s",
                        "childNodesTexts": [
                            "На Ю"
                        ]
                    },
                    {
                        "id": "blocks-e",
                        "childNodesTexts": [
                            "На В"
                        ]
                    },
                    {
                        "id": "blocks-w",
                        "childNodesTexts": [
                            "На З"
                        ]
                    },
                    {
                        "id": "blocks-ne",
                        "childNodesTexts": [
                            "На СВ"
                        ]
                    },
                    {
                        "id": "blocks-se",
                        "childNodesTexts": [
                            "На ЮВ"
                        ]
                    },
                    {
                        "id": "blocks-sw",
                        "childNodesTexts": [
                            "На ЮЗ"
                        ]
                    },
                    {
                        "id": "blocks-nw",
                        "childNodesTexts": [
                            "На СЗ"
                        ]
                    },
                    {
                        "id": "settings-title",
                        "childNodesTexts": [
                            "Настройки"
                        ]
                    },
                    {
                        "id": "settings-back",
                        "childNodesTexts": [
                            "Назад"
                        ]
                    },
                    {
                        "id": "player-symbol-label",
                        "childNodesTexts": [
                            "Символ игрока"
                        ]
                    },
                    {
                        "id": "player-colour-label",
                        "childNodesTexts": [
                            "Цвет игрока"
                        ]
                    },
                    {
                        "id": "player-border-colour-label",
                        "childNodesTexts": [
                            "Цвет обводки игрока"
                        ]
                    },
                    {
                        "id": "game-speed-label",
                        "childNodesTexts": [
                            "Интервал шага (в миллисекундах)"
                        ]
                    },
                    {
                        "id": "game-volume-label",
                        "childNodesTexts": [
                            "Громкость звука"
                        ]
                    },
                    {
                        "id": "default-settings",
                        "childNodesTexts": [
                            "Сбросить все настройки"
                        ]
                    },
                    {
                        "id": "about-title",
                        "childNodesTexts": [
                            "Об игре"
                        ]
                    },
                    {
                        "id": "about-back",
                        "childNodesTexts": [
                            "Назад"
                        ]
                    }
                ]
            }
        ]);

        /**
         * @typedef {Object} Translation
         * @property {string} name
         * @property {string[]} langTags
         * @property {LangElement[]} elements
         */
        /**
         * @param {Translation[]} languages
         */
        function generateLanguagesList(languages) {
            /** @type {HTMLSelectElement} */
            let list = document.getElementById('lang');
            list.addEventListener('change', function (event) {
                selectLanguage(languages, true);
            });

            for (let l of languages) {
                /** @type {HTMLOptionElement} */
                let option = list.appendChild(
                    document.createElement('option')
                );
                option.value = l.name;
                option.textContent = l.name;
            }

            selectLanguage(languages, false);
        }

        /**
         * @param {Translation[]} languages
         * @param {boolean} fromMenu
         */
        function selectLanguage(languages, fromMenu) {
            /** @type {HTMLSelectElement} */
            let menu = document.getElementById('lang');
            /** @type {string} */
            let selection = null;

            if (!fromMenu) {
                if (localStorage.getItem('lang')) {
                    selection = localStorage.getItem('lang');
                    menu.value = selection;
                } else if (navigator.language) {
                    // Iterate over translations
                    for (let l of languages) {
                        // If the valid option is finally found, exit
                        if (selection) {
                            break;
                        } else if (l.langTags) {
                            // Otherwise iterate over the tags and
                            // compare them to the browser language
                            for (let t of l.langTags) {
                                if (navigator.language === t) {
                                    menu.value = l.name;
                                    selection = l.name;
                                    break;
                                }
                            }
                        }
                    }
                }
            } else {
                selection = menu.value;
            }

            if (selection) {
                /** @type {Translation} */
                let translation = {};

                for (let l of languages) {
                    if (l.name === selection) {
                        translation = l;
                        break;
                    }
                }

                if (translation) {
                    localStorage.setItem('lang', selection);

                    for (let e of translation.elements) {
                        let target = document.getElementById(e.id);

                        if (target) {
                            if (e.textContent) {
                                target.textContent = e.textContent;
                            }

                            if (e.placeholder) {
                                target.placeholder = e.placeholder;
                            }

                            if (e.childNodesTexts) {
                                /** @type {number} */
                                let index = 0;

                                for (let c of target.childNodes) {
                                    if (c.textContent
                                        && c.textContent.trim() !== ''
                                        && e.childNodesTexts[index]
                                    ) {
                                        c.textContent = e.childNodesTexts[index];
                                        index ++;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    
        /**
         * @typedef {Object} LangElement
         * @property {string} id
         * @property {string} textContent
         * @property {string} placeholder
         * @property {string[]} childNodesTexts
         */
        function exportTranslationTemplate() {
            /** @type {LangElement[]} */
            let elements = [];

            document.querySelectorAll('body *').forEach((e) => {
                if (e.tagName !== 'DIV'
                    && e.tagName !== 'DETAILS'
                    && e.tagName !== 'TABLE'
                    && e.id
                    && e.id !== 'lang'
                ) {
                    /** @type {LangElement} */
                    let newEl = {};

                    newEl.id = e.id;

                    if (e.childNodes) {
                        newEl.childNodesTexts = [];

                        for (let n of e.childNodes) {
                            if (n.textContent && n.textContent.trim() !== '') {
                                newEl.childNodesTexts.push(n.textContent.trim());
                            }
                        }
                    } else {
                        if (e.textContent) {
                            newEl.textContent = e.textContent;
                        }
                    }

                    if (e.placeholder) {
                        newEl.placeholder = e.placeholder;
                    }

                    if (newEl.textContent
                        || newEl.placeholder
                        || newEl?.childNodesTexts.length > 0
                    ) {
                        elements.push(newEl);
                    }
                }
            });

            let data = encodeURIComponent(JSON.stringify(elements, null, 4));
            exportLang.href = `data:text/plain;charset=utf-8,${data}`;
        }
    </script>
</body>
</html>